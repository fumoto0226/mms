<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>home page</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    background:#000;
  }

  /* åŠ è½½ç•Œé¢æ ·å¼ */
  #loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  #loading-screen.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loading-title {
    color: #fff;
    font-size: 24px;
    margin-bottom: 30px;
    font-family: Arial, sans-serif;
  }

  .progress-container {
    width: 300px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #00ff88, #00ccff);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  .loading-text {
    color: #fff;
    margin-top: 20px;
    font-size: 14px;
    opacity: 0.8;
  }

  #container {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }

  /* â€”â€” ä¸¤å±‚èƒŒæ™¯ï¼šä¸ç½‘æ ¼åŒä¸€ç¼©æ”¾é€»è¾‘ â€”â€” */
  .bg-layer {
    position: absolute;
    top: 50%;
    left: 50%;
    aspect-ratio: calc(23 / 12);
    height: 100vh;
    transform: translate(-50%, -50%);
    background-size: 100% 100%;
    background-position: center;
    background-repeat: no-repeat;
    transition: opacity 220ms ease;
    will-change: opacity;
    pointer-events: none;
  }
  @media (min-aspect-ratio: 23/12) {
    .bg-layer { width: 100vw; height: auto; }
  }
  #bgA { z-index: 0; opacity: 1; }
  #bgB { z-index: 1; opacity: 0; }

  /* â€”â€” ç½‘æ ¼ï¼šåŒæ ·æ¯”ä¾‹ + å¤–åœˆç¦ç”¨ â€”â€” */
  #grid {
    position: absolute;
    top: 50%;
    left: 50%;
    aspect-ratio: calc(23 / 12);
    height: 100vh;
    transform: translate(-50%, -50%);
    display: grid;
    grid-template-columns: repeat(23, 1fr);
    grid-template-rows: repeat(12, 1fr);
    z-index: 2;
  }
  @media (min-aspect-ratio: 23/12) {
    #grid { width: 100vw; height: auto; }
  }
  #grid div {
    border: 1px solid rgba(255,255,255,0.05);
    /* å»æ‰ hover é«˜äº® */
  }
  #grid div.disabled {
    background-color: rgba(255,255,255,0.02);
    pointer-events: none;
  }

  /* AIè¯†åˆ«æ¡†æ ·å¼ */
  .ai-detection-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
  }

  .ai-region {
    position: absolute;
    pointer-events: none;
  }

  /* â€”â€” UI è¦†ç›–å±‚ï¼ˆè´´åœ¨èƒŒæ™¯ä¸Šçš„UIï¼‰ â€”â€” */
  #uiOverlay {
    position: absolute;
    left: 0; top: 0;
    pointer-events: none; /* é»˜è®¤ä¸æ‹¦æˆªäº‹ä»¶ */
    z-index: 20; /* é«˜äºç½‘æ ¼ä¸AIè¯†åˆ«æ¡† */
  }
  
  #uiOverlay .menu {
    pointer-events: auto; /* èœå•å¯ä»¥æ¥æ”¶é¼ æ ‡äº‹ä»¶ */
  }
  #uiOverlay img#logo {
    position: absolute;
    width: 260px; /* å®é™…å°ºå¯¸ç”±JSæŒ‰æ¯”ä¾‹ç¼©æ”¾ */
  }
  #uiOverlay .menu div {
    position: absolute;
    width: 160px;
    padding: 8px 8px 8px 8px;
    background: #000;
    color: #fff;
    font-weight: bold;
    text-align: center;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
    border-radius: 4px; 
    user-select: none;
  }
  
  #uiOverlay .menu div:hover {
    background: #333;
    border-color: #fff;
    transform: scale(1.05);
  }
  
  #uiOverlay .menu div:active {
    background: #555;
    transform: scale(0.95);
  }
  
  #uiOverlay .menu div.clicked {
    background: #666;
    border-color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
  }
  #uiOverlay #version {
    position: absolute;
    font-size: 12px;
    color: #fff;
    opacity: 0.8;
    font-weight: 500; /* å¢åŠ å­—é‡ï¼Œä»é»˜è®¤å˜ä¸ºåŠç²—ä½“ */
  }

  .ai-box {
    position: absolute;
    border: 2px solid var(--region-color);
    background: transparent;
    box-sizing: border-box;
    transform-origin: center;
    opacity: 0;
    animation: expandBox 0.8s ease-out forwards;
  }

  .ai-label {
    position: absolute;
    left: -2px;
    top: -1.5em;
    padding: 2px 6px;
    background: var(--region-color);
    color: rgb(0, 0, 0);
    font-weight: bold;
    font-size: 12px;
    font-family: Arial, sans-serif;
    border-radius: 2px;
    opacity: 0;
    animation: showLabel 1s ease-out 0.8s forwards;
    white-space: nowrap;
    transform: translateY(-5px);
  }

  .ai-label-text {
    display: inline-block;
    min-width: 1ch;
  }

  @keyframes expandBox {
    from { 
      transform: scale(0); 
      opacity: 0; 
    }
    to { 
      transform: scale(1); 
      opacity: 1; 
    }
  }

  @keyframes showLabel {
    from { 
      opacity: 0; 
      transform: translateY(-5px);
    }
    to { 
      opacity: 1; 
      transform: translateY(0);
    }
  }

  /* è¯†åˆ«æ¡†è„‰å†²æ•ˆæœ - ç®€å•çš„é€æ˜åº¦å˜åŒ– */
  .ai-box {
    animation: expandBox 0.8s ease-out forwards, pulse 2s ease-in-out infinite 0.8s;
  }

  @keyframes pulse {
    0%, 100% { 
      opacity: 1;
    }
    50% { 
      opacity: 0.7;
    }
  }
</style>
</head>
<body>
  <!-- åŠ è½½ç•Œé¢ -->
  <div id="loading-screen">
    <div class="loading-title">æ­£åœ¨åŠ è½½ä¸­...</div>
    <div class="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="loading-text" id="loading-text">å‡†å¤‡ä¸­...</div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="container" style="display: none;">
    <div id="bgA" class="bg-layer" style="background-image:url('home/0-0.png')"></div>
    <div id="bgB" class="bg-layer" style="background-image:url('home/0-0.png')"></div>
    <div id="grid"></div>
    <!-- AIè¯†åˆ«æ¡†å®¹å™¨ -->
    <div id="ai-detection-container" class="ai-detection-container"></div>
    <!-- èƒŒæ™¯è´´é™„UIå®¹å™¨ -->
    <div id="uiOverlay">
      <img id="logo" src="img/logo01.svg" alt="logo">
      <div class="menu">
        <div>è¨˜éŒ²</div>
        <div>ã‚¢ãƒ«ãƒãƒ </div>
        <div>è¨­å®š</div>
      </div>
      <div id="version">ver.1.0.0.20251027-beta</div>
    </div>
  </div>

<script>
const grid = document.getElementById('grid');
const bgA  = document.getElementById('bgA');
const bgB  = document.getElementById('bgB');
const loadingScreen = document.getElementById('loading-screen');
const progressBar = document.getElementById('progress-bar');
const loadingText = document.getElementById('loading-text');
const container = document.getElementById('container');
const aiDetectionContainer = document.getElementById('ai-detection-container');
const uiOverlay = document.getElementById('uiOverlay');

let showing = bgA;         // å½“å‰å¯è§å±‚
let hidden  = bgB;         // å½“å‰éšè—å±‚
let requestSeq = 0;        // æ‚¬åœè¯·æ±‚åºå·ï¼ˆé˜²ç«æ€ï¼‰
const cache = new Map();   // å›¾ç‰‡ç¼“å­˜ï¼šurl -> Imageå¯¹è±¡
const imageCache = new Map(); // æŒä¹…åŒ–å›¾ç‰‡ç¼“å­˜ï¼šurl -> Imageå¯¹è±¡

// åŠ è½½çŠ¶æ€
let totalImages = 0;
let loadedImages = 0;
let isPreloading = true;

/** é¢„åŠ è½½å›¾ç‰‡ï¼Œç¡®ä¿åˆ‡æ¢å‰ä¸€å®šå·²å°±ç»ª */
function preload(url) {
  // å¦‚æœå›¾ç‰‡å·²ç»åœ¨æŒä¹…åŒ–ç¼“å­˜ä¸­ï¼Œç›´æ¥è¿”å›
  if (imageCache.has(url)) {
    return Promise.resolve(imageCache.get(url));
  }
  
  // å¦‚æœæ­£åœ¨åŠ è½½ä¸­ï¼Œè¿”å›ç°æœ‰çš„Promise
  if (cache.has(url)) {
    return cache.get(url);
  }
  
  const p = new Promise((resolve, reject) => {
    const img = new Image();
    img.src = url;
    
    img.onload = () => {
      // å°†å›¾ç‰‡å¯¹è±¡ä¿å­˜åˆ°æŒä¹…åŒ–ç¼“å­˜
      imageCache.set(url, img);
      cache.delete(url); // ä»ä¸´æ—¶ç¼“å­˜ä¸­åˆ é™¤
      
      if (isPreloading) {
        loadedImages++;
        updateProgress();
      }
      resolve(img);
    };
    
    img.onerror = () => {
      cache.delete(url);
      if (isPreloading) {
        loadedImages++;
        updateProgress();
      }
      reject(new Error(`Failed to load ${url}`));
    };
    
    // å°è¯•æ›´å¯é çš„ decodeï¼ˆæ›´å°‘é—ªçƒï¼‰
    if ('decode' in img) {
      img.decode().catch(() => {
        // decodeå¤±è´¥æ—¶ä¾èµ–onloadäº‹ä»¶
      });
    }
  });
  
  cache.set(url, p);
  return p;
}

/** æ›´æ–°åŠ è½½è¿›åº¦ */
function updateProgress() {
  const progress = Math.round((loadedImages / totalImages) * 100);
  progressBar.style.width = progress + '%';
  loadingText.textContent = `å·²åŠ è½½ ${loadedImages}/${totalImages} å¼ å›¾ç‰‡ (${progress}%)`;
  
  if (loadedImages >= totalImages) {
    setTimeout(() => {
      showMainInterface();
    }, 500); // å»¶è¿Ÿ500msæ˜¾ç¤ºä¸»ç•Œé¢
  }
}

/** æ˜¾ç¤ºä¸»ç•Œé¢ */
function showMainInterface() {
  loadingScreen.classList.add('hidden');
  container.style.display = 'block';
  isPreloading = false;
  
  // ç¡®ä¿åˆå§‹èƒŒæ™¯å·²è®¾ç½®
  bgA.style.backgroundImage = 'url(home/0-0.png)';
  bgB.style.backgroundImage = 'url(home/0-0.png)';
  
  // è¾“å‡ºç¼“å­˜çŠ¶æ€ä¿¡æ¯
  console.log(`å›¾ç‰‡ç¼“å­˜å®Œæˆ: ${imageCache.size} å¼ å›¾ç‰‡å·²ç¼“å­˜`);
}

/** éªŒè¯ç¼“å­˜çŠ¶æ€ */
function validateCache() {
  console.log(`å½“å‰ç¼“å­˜çŠ¶æ€: ${imageCache.size} å¼ å›¾ç‰‡`);
  console.log(`ä¸´æ—¶ç¼“å­˜çŠ¶æ€: ${cache.size} ä¸ªåŠ è½½ä¸­`);
}

/** åˆ‡æ¢èƒŒæ™¯ï¼šä»…åœ¨æ–°å›¾å®Œå…¨åŠ è½½åæ‰æ·¡å…¥ï¼Œå¹¶ä¸”åªå“åº”æœ€åä¸€æ¬¡è¯·æ±‚ */
async function switchTo(url) {
  const mySeq = ++requestSeq;
  try {
    // ç¡®ä¿å›¾ç‰‡å·²åŠ è½½å¹¶ç¼“å­˜
    const img = await preload(url);
    
    // æœŸé—´å¦‚æœåˆæ¥äº†æ›´æ–°è¯·æ±‚ï¼Œå°±æ”¾å¼ƒè¿™æ¬¡åˆ‡æ¢
    if (mySeq !== requestSeq) return;

    // éªŒè¯å›¾ç‰‡å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
    if (!img || !img.complete) {
      console.warn('Image not ready:', url);
      return;
    }

    // å…ˆæŠŠæ–°å›¾æ”¾åˆ°éšè—å±‚ï¼Œä½†ä»ä¿æŒéšè—å±‚ opacity=0
    hidden.style.backgroundImage = `url(${url})`;
    
    // å¼ºåˆ¶é‡ç»˜ï¼Œç¡®ä¿å›¾ç‰‡å·²æ¸²æŸ“
    hidden.offsetHeight;

    // å†å¼€å§‹äº¤å‰æ·¡å…¥ï¼ˆæ—§å›¾å§‹ç»ˆå¯è§ç›´åˆ°æ­¤åˆ»ï¼‰
    hidden.style.opacity = '1';
    showing.style.opacity = '0';

    // ç›‘å¬ä¸€æ¬¡è¿‡æ¸¡ç»“æŸåäº¤æ¢è§’è‰²
    const done = new Promise(res => {
      const handler = () => {
        hidden.removeEventListener('transitionend', handler);
        res();
      };
      hidden.addEventListener('transitionend', handler);
    });
    await done;

    // äº¤æ¢å±‚å¼•ç”¨ï¼Œç¡®ä¿ä¸‹ä¸€æ¬¡åˆ‡æ¢ä»ç„¶å¹³æ»‘
    const tmp = showing; showing = hidden; hidden = tmp;
  } catch (e) {
    // åŠ è½½å¤±è´¥æ—¶ä¿æŒå½“å‰ç”»é¢ä¸å˜ï¼ˆä¸é—ªé»‘ï¼‰
    console.warn('Image load failed:', url, e);
  }
}

// â€”â€” UI è¦†ç›–å±‚å¸ƒå±€ï¼ˆä¸èƒŒæ™¯ä¸€è‡´çš„ aspect-fill é€»è¾‘ï¼‰ â€”â€”
const uiBaseWidth = 1920;
const uiBaseHeight = 960;
function layoutUI() {
  if (!uiOverlay) return;
  const W = window.innerWidth;
  const H = window.innerHeight;
  const scale = Math.max(W / uiBaseWidth, H / uiBaseHeight);
  const viewW = uiBaseWidth * scale;
  const viewH = uiBaseHeight * scale;
  const offsetX = (W - viewW) / 2;
  const offsetY = (H - viewH) / 2;

  // å®¹å™¨å°ºå¯¸ä¸ä½ç½®
  uiOverlay.style.width = `${viewW}px`;
  uiOverlay.style.height = `${viewH}px`;
  uiOverlay.style.left = `${offsetX}px`;
  uiOverlay.style.top = `${offsetY}px`;

  // logo
  const logo = document.getElementById('logo');
  if (logo) {
    logo.style.left = `${950 * scale}px`;//ä½ç½®
    logo.style.top = `${60 * scale}px`;
    logo.style.width = `${860 * scale}px`;//å¤§å°
  }

  // èœå•ï¼ˆé»‘åº•ç™½å­—æŒ‰é’®ï¼‰
  const menuItems = uiOverlay.querySelectorAll('.menu div');
  const baseY = 350; // èµ·å§‹ y åæ ‡ï¼ˆåŸºäº 1920Ã—960ï¼‰
  const step = 76;   // æ¯é¡¹é—´éš”
  const menuX = 1560; // ğŸ¯ èœå•ä½ç½® X åæ ‡ï¼ˆä» 1650 æ”¹ä¸º 1500ï¼Œå¾€å·¦ç§»åŠ¨ 150pxï¼‰
  menuItems.forEach((m, i) => {
    m.style.left = `${menuX * scale}px`; // ğŸ¯ ä¿®æ”¹ä½ç½®ï¼šå¾€å·¦ç§»åŠ¨
    m.style.top = `${(baseY + i * step) * scale}px`;
    m.style.width = `${160 * scale}px`;
    m.style.fontSize = `${20 * scale}px`;
  });

  // ç‰ˆæœ¬å·
  const version = document.getElementById('version');
  if (version) {
    version.style.left = `${1560 * scale}px`;
    version.style.top = `${880 * scale}px`;
    version.style.fontSize = `${16 * scale}px`;
  }
}


// ç¦»å¼€ç½‘æ ¼æ¢å¤é»˜è®¤å›¾ï¼ˆåŒæ ·ç­‰åŠ è½½å¥½å†åˆ‡ï¼‰
grid.addEventListener('mouseleave', () => {
  switchTo('home/0-0.png');
  // ç«‹å³æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨å’Œè¯†åˆ«æ¡†
  if (hideTimeout) {
    clearTimeout(hideTimeout);
    hideTimeout = null;
  }
  hideAllAIRegions();
  currentAIRegion = null;
  console.log('ç¦»å¼€ç½‘æ ¼ï¼Œéšè—æ‰€æœ‰è¯†åˆ«æ¡†');
});

/** ç”Ÿæˆæ‰€æœ‰éœ€è¦é¢„åŠ è½½çš„å›¾ç‰‡URL */
function generateAllImageUrls() {
  const urls = ['home/0-0.png']; // é»˜è®¤å›¾ç‰‡
  
  // ç”Ÿæˆæ‰€æœ‰ç½‘æ ¼åŒºåŸŸçš„å›¾ç‰‡URL
  for (let r = 2; r <= 11; r++) {
    for (let c = 2; c <= 22; c++) {
      urls.push(`home/${r}-${c}.png`);
    }
  }
  
  return urls;
}

/** å¼€å§‹é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡ */
async function preloadAllImages() {
  const allUrls = generateAllImageUrls();
  totalImages = allUrls.length;
  loadedImages = 0;
  
  loadingText.textContent = `å‡†å¤‡åŠ è½½ ${totalImages} å¼ å›¾ç‰‡...`;
  
  // æ‰¹é‡é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
  const preloadPromises = allUrls.map(url => 
    preload(url).catch(error => {
      console.warn(`Failed to load ${url}:`, error);
    })
  );
  
  // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
  await Promise.allSettled(preloadPromises);
}

// é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹é¢„åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
  preloadAllImages();
  // åˆå§‹åŒ–UIå¸ƒå±€
  layoutUI();
  // åˆå§‹åŒ–èœå•äº¤äº’
  setupMenuInteractions();
  
  // å®šæœŸéªŒè¯ç¼“å­˜çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰
  setInterval(() => {
    if (!isPreloading) {
      validateCache();
    }
  }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
});

// çª—å£å°ºå¯¸å˜åŒ–æ—¶ï¼ŒåŒæ­¥æ›´æ–°UIå¸ƒå±€
window.addEventListener('resize', layoutUI);

// èœå•äº¤äº’åŠŸèƒ½
function setupMenuInteractions() {
  const menuItems = document.querySelectorAll('#uiOverlay .menu div');
  
  menuItems.forEach((item, index) => {
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    item.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // ç§»é™¤å…¶ä»–èœå•é¡¹çš„ç‚¹å‡»çŠ¶æ€
      menuItems.forEach(otherItem => {
        otherItem.classList.remove('clicked');
      });
      
      // æ·»åŠ å½“å‰é¡¹çš„ç‚¹å‡»çŠ¶æ€
      item.classList.add('clicked');
      
      // æ ¹æ®èœå•é¡¹æ‰§è¡Œä¸åŒæ“ä½œ
      const menuText = item.textContent.trim();
      console.log(`ç‚¹å‡»äº†èœå•é¡¹: ${menuText}`);
      
      // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„åŠŸèƒ½é€»è¾‘
      switch(menuText) {
        case 'è¨˜éŒ²':
          console.log('æ‰“å¼€è®°å½•åŠŸèƒ½');
          break;
        case 'ã‚¢ãƒ«ãƒãƒ ':
          console.log('æ‰“å¼€ç›¸å†ŒåŠŸèƒ½');
          break;
        case 'è¨­å®š':
          console.log('æ‰“å¼€è®¾ç½®åŠŸèƒ½');
          break;
        default:
          console.log('æœªçŸ¥èœå•é¡¹');
      }
      
      // 2ç§’åç§»é™¤ç‚¹å‡»çŠ¶æ€
      setTimeout(() => {
        item.classList.remove('clicked');
      }, 2000);
    });
    
    // æ·»åŠ é¼ æ ‡è¿›å…¥äº‹ä»¶
    item.addEventListener('mouseenter', () => {
      console.log(`é¼ æ ‡æ‚¬æµ®: ${item.textContent.trim()}`);
    });
    
    // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
    item.addEventListener('mouseleave', () => {
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¦»å¼€æ—¶çš„æ•ˆæœ
    });
  });
}

// æ·»åŠ å…¨å±€ç¼“å­˜éªŒè¯å‡½æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰
window.validateImageCache = validateCache;
window.getCacheSize = () => imageCache.size;

// ========== AIè¯†åˆ«æ¡†åŠŸèƒ½ ==========

// è¯†åˆ«åŒºåŸŸæ•°æ® - ç®€åŒ–çš„åŒºåŸŸå®šä¹‰
const regions = {
    // 10-10åŒºåŸŸçš„è¯†åˆ«æ¡†
    "10-10": [
    {
      x: 500, y: 300, width: 200, height: 150,
      color: "#FF6B6B", name: "New Object"
    },
    {
      x: 800, y: 400, width: 150, height: 100,
      color: "#4ECDC4", name: "Another Object"
    }
  ],
   // 11-15åŒºåŸŸçš„è¯†åˆ«æ¡†
   "11-15": [
    {
      x: 300, y: 100, width: 200, height: 150,
      color: "#00FF88", name: "Garden"
    },
    {
      x: 600, y: 300, width: 180, height: 200,
      color: "#FF6B6B", name: "Fountain"
    }
  ],
  // 11-16åŒºåŸŸçš„è¯†åˆ«æ¡†
  "11-16": [
    {
      x: 960, y: 20, width: 180, height: 440,
      color: "#96FD00", name: "Yoyogi Building"
    },
    {
      x: 200, y: 200, width: 160, height: 120,
      color: "#F807FD", name: "Tree"
    },
    {
      x: 400, y: 500, width: 260, height: 140,
      color: "#F807FD", name: "Tree"
    }
  ],
 
};

// å…¨å±€çŠ¶æ€è·Ÿè¸ª
let currentAIRegion = null;
let hideTimeout = null;

// ç®€åŒ–çš„åŒºåŸŸå¤„ç†å‡½æ•°
function setupAIRegion(gridRow, gridCol) {
  const regionKey = `${gridRow}-${gridCol}`;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰è¯¥åŒºåŸŸçš„è¯†åˆ«æ¡†æ•°æ®
  if (regions[regionKey]) {
    return {
      isAIRegion: true,
      regionKey: regionKey
    };
  }
  
  return { isAIRegion: false };
}

// å®‰å…¨çš„æ˜¾ç¤ºè¯†åˆ«æ¡†å‡½æ•°
function safeShowAIRegions(regionKey) {
  // æ¸…é™¤éšè—å®šæ—¶å™¨
  if (hideTimeout) {
    clearTimeout(hideTimeout);
    hideTimeout = null;
  }
  
  // å¦‚æœå·²ç»æ˜¯å½“å‰åŒºåŸŸï¼Œä¸é‡å¤æ˜¾ç¤º
  if (currentAIRegion === regionKey) {
    return;
  }
  
  // æ˜¾ç¤ºæ–°åŒºåŸŸçš„è¯†åˆ«æ¡†
  showAIRegions(regionKey);
  currentAIRegion = regionKey;
  console.log(`åˆ‡æ¢åˆ°åŒºåŸŸ ${regionKey} çš„è¯†åˆ«æ¡†`);
}

// å®‰å…¨çš„éšè—è¯†åˆ«æ¡†å‡½æ•°
function safeHideAIRegions() {
  // æ¸…é™¤éšè—å®šæ—¶å™¨
  if (hideTimeout) {
    clearTimeout(hideTimeout);
  }
  
  // å»¶è¿Ÿéšè—ï¼Œç»™å…¶ä»–åŒºåŸŸåˆ‡æ¢ç•™æ—¶é—´
  hideTimeout = setTimeout(() => {
    hideAllAIRegions();
    currentAIRegion = null;
    console.log('éšè—æ‰€æœ‰è¯†åˆ«æ¡†');
  }, 150);
}

// ä¹±ç å­—ç¬¦é›†
const garbledChars = "@#Â¥%*&!?$^~`|\\/<>{}[]()+=_-";

/**
 * ç”Ÿæˆéšæœºä¹±ç æ–‡å­—
 * @param {string} targetText ç›®æ ‡æ–‡å­—
 * @param {number} length ä¹±ç é•¿åº¦
 * @returns {string} ä¹±ç æ–‡å­—
 */
function generateGarbledText(targetText, length) {
  let garbled = '';
  for (let i = 0; i < length; i++) {
    garbled += garbledChars[Math.floor(Math.random() * garbledChars.length)];
  }
  return garbled;
}

/**
 * æ–‡å­—ä»ä¹±ç å˜ä¸ºæ­£ç¡®æ–‡å­—çš„åŠ¨ç”»
 * @param {HTMLElement} textElement æ–‡å­—å…ƒç´ 
 * @param {string} targetText ç›®æ ‡æ–‡å­—
 * @param {number} duration åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 */
function animateTextReveal(textElement, targetText, duration = 1000) {
  const textLength = targetText.length;
  const interval = duration / (textLength * 3); // æ¯ä¸ªå­—ç¬¦åˆ·æ–°3æ¬¡
  
  let currentIndex = 0;
  let animationFrame = 0;
  
  const animate = () => {
    if (currentIndex < textLength) {
      // ç”Ÿæˆå½“å‰è¿›åº¦çš„ä¹±ç æ–‡å­—
      const garbledLength = Math.max(1, textLength - currentIndex);
      const garbledText = generateGarbledText(targetText, garbledLength);
      const revealedText = targetText.substring(0, currentIndex);
      
      textElement.textContent = revealedText + garbledText;
      
      // æ¯3å¸§æ›´æ–°ä¸€æ¬¡å­—ç¬¦
      if (animationFrame % 3 === 0) {
        currentIndex++;
      }
      animationFrame++;
      
      requestAnimationFrame(animate);
    } else {
      // åŠ¨ç”»ç»“æŸï¼Œæ˜¾ç¤ºæœ€ç»ˆæ–‡å­—
      textElement.textContent = targetText;
    }
  };
  
  animate();
}


/**
 * åˆ›å»ºAIè¯†åˆ«æ¡†
 * @param {Object} region åŒºåŸŸæ•°æ®
 * @param {number} delay å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 */
function createAIRegion(region, delay = 0) {
  setTimeout(() => {
    // åˆ›å»ºåŒºåŸŸå®¹å™¨
    const regionElement = document.createElement('div');
    regionElement.className = 'ai-region';
    regionElement.style.left = region.x + 'px';
    regionElement.style.top = region.y + 'px';
    regionElement.style.setProperty('--region-color', region.color);
    
    // åˆ›å»ºè¯†åˆ«æ¡†
    const boxElement = document.createElement('div');
    boxElement.className = 'ai-box';
    boxElement.style.width = region.width + 'px';
    boxElement.style.height = region.height + 'px';
    
    // åˆ›å»ºæ ‡ç­¾
    const labelElement = document.createElement('div');
    labelElement.className = 'ai-label';
    
    const labelTextElement = document.createElement('span');
    labelTextElement.className = 'ai-label-text';
    labelElement.appendChild(labelTextElement);
    
    // ç»„è£…å…ƒç´ 
    regionElement.appendChild(boxElement);
    regionElement.appendChild(labelElement);
    aiDetectionContainer.appendChild(regionElement);
    
    // å¯åŠ¨æ–‡å­—åŠ¨ç”»ï¼ˆå»¶è¿Ÿ1.2ç§’ï¼Œç­‰æ¡†åŠ¨ç”»å®Œæˆï¼‰
    setTimeout(() => {
      animateTextReveal(labelTextElement, region.name, 800);
    }, 1200);
    
  }, delay);
}

/**
 * æ˜¾ç¤ºæŒ‡å®šåŒºåŸŸçš„AIè¯†åˆ«æ¡†
 * @param {string} regionKey åŒºåŸŸé”®åï¼ˆå¦‚"11-16"æˆ–"11-15"ï¼‰
 * @param {number} staggerDelay æ¯ä¸ªæ¡†ä¹‹é—´çš„å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
 */
function showAIRegions(regionKey, staggerDelay = 300) {
  // æ¸…ç©ºç°æœ‰è¯†åˆ«æ¡†
  aiDetectionContainer.innerHTML = '';
  
  // è·å–æŒ‡å®šåŒºåŸŸçš„è¯†åˆ«æ¡†æ•°æ®
  const regionData = regions[regionKey];
  if (!regionData) {
    console.warn(`Region ${regionKey} not found`);
    return;
  }
  
  // ä¾æ¬¡åˆ›å»ºè¯†åˆ«æ¡†
  regionData.forEach((region, index) => {
    createAIRegion(region, index * staggerDelay);
  });
}

/**
 * æ˜¾ç¤ºæ‰€æœ‰AIè¯†åˆ«æ¡†ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
 * @param {number} staggerDelay æ¯ä¸ªæ¡†ä¹‹é—´çš„å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
 */
function showAllAIRegions(staggerDelay = 300) {
  // é»˜è®¤æ˜¾ç¤º11-16åŒºåŸŸçš„è¯†åˆ«æ¡†
  showAIRegions("11-16", staggerDelay);
}

/**
 * éšè—æ‰€æœ‰AIè¯†åˆ«æ¡†
 */
function hideAllAIRegions() {
  aiDetectionContainer.innerHTML = '';
}


// æ·»åŠ å…¨å±€å‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
window.showAIRegions = showAIRegions;
window.showAllAIRegions = showAllAIRegions;
window.hideAIRegions = hideAllAIRegions;
window.createAIRegion = createAIRegion;

/** ç”Ÿæˆç½‘æ ¼å¹¶ç»‘å®šäº‹ä»¶ï¼ˆå¤–åœˆç¦ç”¨ï¼‰ */
for (let r = 1; r <= 12; r++) {
  for (let c = 1; c <= 23; c++) {
    const cell = document.createElement('div');
    const isEdge = (r === 1 || r === 12 || c === 1 || c === 23);
    
    if (isEdge) {
      cell.classList.add('disabled');
    } else {
      // æ£€æŸ¥æ˜¯å¦æ˜¯è“è‰²åŒºåŸŸï¼ˆæ˜¾ç¤º0-0å›¾ç‰‡ï¼‰
      const isBlueRegion = (
        // ç¬¬ä¸€ä¸ªè“è‰²å—ï¼šè¡Œ2-4ï¼Œåˆ—12-22
        (r >= 2 && r <= 4 && c >= 12 && c <= 22) ||
        // ç¬¬äºŒä¸ªè“è‰²å—ï¼šè¡Œ5-11ï¼Œåˆ—19-22
        (r >= 5 && r <= 11 && c >= 19 && c <= 22)
      );
      
      if (isBlueRegion) {
        // è“è‰²åŒºåŸŸï¼šæ‚¬åœæ—¶æ˜¾ç¤º0-0å›¾ç‰‡
        cell.addEventListener('mouseenter', () => {
          switchTo('home/0-0.png');
        });
      } else {
        // æ£€æŸ¥æ˜¯å¦æ˜¯AIè¯†åˆ«åŒºåŸŸ
        const aiRegion = setupAIRegion(r, c);
        
        if (aiRegion.isAIRegion) {
          // AIè¯†åˆ«åŒºåŸŸï¼šæ‚¬åœæ—¶æ˜¾ç¤ºè¯¥åŒºåŸŸçš„è¯†åˆ«æ¡†
          cell.addEventListener('mouseenter', () => {
            switchTo(`home/${r}-${c}.png`);
            safeShowAIRegions(aiRegion.regionKey);
          });
          cell.addEventListener('mouseleave', () => {
            safeHideAIRegions();
          });
        } else {
          // æ™®é€šåŒºåŸŸï¼šåªåˆ‡æ¢èƒŒæ™¯
          cell.addEventListener('mouseenter', () => {
            switchTo(`home/${r}-${c}.png`);
          });
        }
      }
    }
    grid.appendChild(cell);
  }
}
</script>
</body>
</html>
