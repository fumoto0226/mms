<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>äº¤äº’å¼åœ°å›¾å›¾é’‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
    import { getDatabase, ref, push, onChildAdded, onChildRemoved, onChildChanged, remove, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCykK_RTGswJ6l2QEPnFGrjQXl0BujgVrY",
      authDomain: "fumoto-0226.firebaseapp.com",
      databaseURL: "https://fumoto-0226-default-rtdb.asia-southeast1.firebasedatabase.app",  
      projectId: "fumoto-0226",
      storageBucket: "fumoto-0226.appspot.com",
      messagingSenderId: "441538134557",
      appId: "1:441538134557:web:9106abefa6aecc923a3cf4",
      measurementId: "G-EEEFPL8SNV"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app, "gs://fumoto-0226.firebasestorage.app");

    
    // åŒ¿åç™»å½•
    signInAnonymously(auth)
      .then(() => {
        console.log('åŒ¿åç™»å½•æˆåŠŸï¼ŒUID:', auth.currentUser.uid);
        window.currentUID = auth.currentUser.uid;
        // é€šçŸ¥ä¸»è„šæœ¬ç™»å½•å®Œæˆ
        window.dispatchEvent(new Event('firebaseAuthReady'));
      })
      .catch((error) => {
        console.error('åŒ¿åç™»å½•å¤±è´¥:', error);
      });
    
    // å°† Firebase å®ä¾‹æš´éœ²åˆ°å…¨å±€
    window.firebaseApp = app;
    window.firebaseDatabase = database;
    window.firebaseAuth = auth;
    window.firebaseStorage = storage;
    window.firebaseRef = ref;
    window.firebasePush = push;
    window.firebaseOnChildAdded = onChildAdded;
    window.firebaseOnChildRemoved = onChildRemoved;
    window.firebaseOnChildChanged = onChildChanged;
    window.firebaseRemove = remove;
    window.firebaseUpdate = update;
    window.firebaseStorageRef = storageRef;
    window.firebaseUploadBytes = uploadBytes;
    window.firebaseGetDownloadURL = getDownloadURL;
  </script>
  <style>
    html, body {
      margin: 0; 
      padding: 0; 
      height: 100%; 
      overflow: hidden;
    }
    
    #map {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: calc(100% - 320px); 
      height: 100%;
    }
    
    /* è¿”å›æŒ‰é’® */
    #backBtn {
      position: fixed; 
      top: 20px; 
      left: 20px; 
      z-index: 1000;
      background: #333; 
      color: white; 
      border: none; 
      border-radius: 50px;
      padding: 12px 24px; 
      font-size: 16px; 
      font-weight: bold; 
      cursor: pointer; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
      transition: all 0.3s ease;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    #backBtn:hover {
      background: #555;
      transform: scale(1.05);
    }
    
    /* æ·»åŠ å›¾é’‰æŒ‰é’® - å·²ç§»åˆ°ä¾§è¾¹æ ï¼Œä¿ç•™æ ·å¼ç”¨äºactiveçŠ¶æ€ */
    #addPinBtn.active {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* å›¾é’‰ SVG å…ƒç´ æ ·å¼ ï¼ˆæ”¹å›¾é’‰å¤§å°ï¼‰*/
    .pin-svg {
      position: absolute;
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: transform 0.3s ease;
      transform-origin: bottom center;
      z-index: 100;
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    /* Firebase å›¾é’‰æ ·å¼ï¼ˆæ›´å°ï¼‰ */
    .pin-svg-firebase {
      position: absolute;
      width: 41px;
      height: 41px;
      cursor: pointer;
      transition: transform 0.3s ease;
      transform-origin: bottom center;
      z-index: 100;
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .pin-svg img {
      width: 100%;
      height: 100%;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .pin-svg-firebase img {
      width: 100%;
      height: 100%;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    /* éšè— Mapbox é»˜è®¤æ ‡è®° */
    .mapboxgl-marker {
      opacity: 0;
      pointer-events: none;
    }
    
    /* æ–‡å­—ä¿¡æ¯è¾“å…¥æ¡† */
    #pinEditor {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 24px;
      width: 90%;
      max-width: 400px;
      z-index: 2000;
      display: none;
    }
    
    #pinEditor.show {
      display: block;
      animation: fadeInScale 0.3s ease;
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    #pinEditor h3 {
      margin: 0 0 16px 0;
      color: #333;
      font-size: 20px;
    }
    
    #pinTextInput {
      width: 100%;
      height: 80px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    
    #pinTextInput:focus {
      outline: none;
      border-color: #007bff;
    }
    
    /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
    .upload-section {
      margin-top: 12px;
      padding: 12px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .upload-section:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    
    .upload-section input {
      display: none;
    }
    
    .upload-label {
      color: #666;
      font-size: 14px;
      cursor: pointer;
    }
    
    .image-preview {
      margin-top: 12px;
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      display: none;
    }
    
    .image-preview.show {
      display: block;
    }
    
    .editor-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .editor-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #publishBtn {
      background: #007bff;
      color: white;
    }
    
    #publishBtn:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    
    #cancelBtn {
      background: #f0f0f0;
      color: #666;
    }
    
    #cancelBtn:hover {
      background: #e0e0e0;
      transform: translateY(-2px);
    }
    
    /* å›¾é’‰æ–‡å­—æµ®çª— */
    #pinPopup {
      position: absolute;
      background: #efefef;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 12px 16px;
      max-width: 300px;
      z-index: 500;
      pointer-events: auto;
      font-size: 15px;
      font-weight: 500;
      color: #515157;
      opacity: 0;
      /* é»˜è®¤çŠ¶æ€ï¼šåœ¨ä¸‹æ–¹ï¼Œç¼©å°ï¼Œä»¥åº•éƒ¨ä¸­å¿ƒä¸ºé”šç‚¹ */
      transform: translateX(-50%) translateY(calc(-100% + 20px)) scale(0.8);
      /* åªå¯¹ opacity å’Œ transform æ·»åŠ è¿‡æ¸¡ï¼Œleft/top ä½ç½®å˜åŒ–ä¸éœ€è¦è¿‡æ¸¡ */
      transition: opacity 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    #pinPopup.show {
      opacity: 1;
      /* æ˜¾ç¤ºçŠ¶æ€ï¼šåº•éƒ¨å±…ä¸­ï¼Œæ­£å¸¸å¤§å° */
      transform: translateX(-50%) translateY(-100%) scale(1);
    }
    
    /* æµ®çª—å°ä¸‰è§’ */
    #pinPopup::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #D9D9D9;
    }
    
    /* æµ®çª—å›¾ç‰‡ */
    .popup-image {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    /* åº•éƒ¨ä¿¡æ¯æ ï¼ˆæ—¶é—´+ç‚¹èµï¼‰ */
    .popup-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 8px;
      gap: 12px;
    }
    
    /* æµ®çª—æ—¶é—´ */
    .popup-time {
      font-size: 11px;
      color: #515157;
      opacity: 0.7;
    }
    
    /* ç‚¹èµåŒºåŸŸ */
    .popup-like {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }
    
    .popup-like:hover {
      transform: scale(1.05);
    }
    
    .like-text {
      font-size: 12px;
      color: #515157;
      font-weight: 600;
    }
    
    .like-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .like-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .like-icon.liked {
      animation: likeAnimation 0.5s ease;
    }
    
    @keyframes likeAnimation {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.3); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.1); }
    }
    
    .like-count {
      font-size: 13px;
      font-weight: 600;
      color: #515157;
      min-width: 16px;
    }
    
    /* æµ®çª—æŒ‰é’® */
    .popup-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .popup-btn {
      flex: 1;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .edit-btn {
      background: #007bff;
      color: white;
    }
    
    .edit-btn:hover {
      background: #0056b3;
    }
    
    .delete-btn {
      background: #dc3545;
      color: white;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    /* å›¾é’‰å‡ºç°å¼¹è·³åŠ¨ç”» */
    @keyframes pinBounce {
      0% {
        transform: scale(0);
      }
      50% {
        transform: scale(1.3);
      }
      70% {
        transform: scale(0.9);
      }
      85% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    /* é»‘è‰²é€æ˜é®ç½©å±‚ */
    #mapOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: calc(100% - 320px);
      height: 100%;
      z-index: 50;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    #mapOverlay svg {
      width: 100%;
      height: 100%;
    }
    
    /* ä¾§è¾¹æ æ ·å¼ - æ·±è‰²ä¸»é¢˜ */
    #sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      height: 100%;
      background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
      border-left: 2px solid #333;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 8px rgba(0,0,0,0.5);
    }
    
    /* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
    .user-info {
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
      padding: 16px;
      color: white;
      border-bottom: 2px solid #333;
    }
    
    .user-info-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .user-emoji {
      font-size: 32px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border: 2px solid rgba(102, 126, 234, 0.5);
    }
    
    .user-details {
      flex: 1;
    }
    
    .user-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .user-ip {
      font-size: 11px;
      opacity: 0.9;
      font-family: 'Courier New', monospace;
    }
    
    /* åœ¨çº¿ç”¨æˆ·åŒºåŸŸ */
    .online-users-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #1a1a1a;
    }
    
    .section-header {
      background: #2d2d2d;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: bold;
      color: #fff;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .online-count {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    
    .user-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .user-list-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .user-list-item:hover {
      background: #2d2d2d;
    }
    
    .user-list-item .user-emoji {
      font-size: 20px;
      width: 24px;
      height: 24px;
      background: #333;
    }
    
    .user-list-item .user-ip {
      font-size: 11px;
      color: #aaa;
      font-family: 'Courier New', monospace;
    }
    
    /* èŠå¤©åŒºåŸŸ */
    .chat-section {
      display: flex;
      flex-direction: column;
      height: 300px;
      background: #1a1a1a;
      border-top: 2px solid #333;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: #0d0d0d;
      font-size: 12px;
    }
    
    .chat-message {
      margin-bottom: 8px;
      padding: 6px 8px;
      background: #2d2d2d;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }
    
    .chat-message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 10px;
      color: #aaa;
    }
    
    .chat-message-user {
      font-weight: bold;
      color: #667eea;
    }
    
    .chat-message-time {
      color: #888;
    }
    
    .chat-message-content {
      color: #fff;
      word-wrap: break-word;
    }
    
    .chat-input-area {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: #2d2d2d;
      border-top: 1px solid #333;
    }
    
    .chat-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 12px;
      resize: none;
      font-family: inherit;
      background: #1a1a1a;
      color: #fff;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .chat-send-btn {
      padding: 6px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    .chat-send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    
    /* åŠŸèƒ½æŒ‰é’®åŒºåŸŸ */
    .action-buttons {
      padding: 12px;
      background: #1a1a1a;
      border-top: 2px solid #333;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .action-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .action-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .action-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    
    .action-btn-primary.active {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 2px 4px rgba(245, 87, 108, 0.3);
    }
    
    .action-btn-primary.active:hover {
      box-shadow: 0 4px 8px rgba(245, 87, 108, 0.4);
    }
    
    .action-btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(245, 87, 108, 0.3);
    }
    
    .action-btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(245, 87, 108, 0.4);
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ - æ·±è‰²ä¸»é¢˜ */
    .user-list::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .user-list::-webkit-scrollbar-track,
    .chat-messages::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    .user-list::-webkit-scrollbar-thumb,
    .chat-messages::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }
    
    .user-list::-webkit-scrollbar-thumb:hover,
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="mapOverlay"></div>
  <button id="backBtn">â† è¿”å›</button>
  
  <!-- ä¾§è¾¹æ  -->
  <div id="sidebar">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-info">
      <div class="user-info-header">
        <div class="user-emoji" id="userEmoji">ğŸ‘¤</div>
        <div class="user-details">
          <div class="user-name">å½“å‰ç”¨æˆ·</div>
          <div class="user-ip" id="userIP">è·å–ä¸­...</div>
        </div>
      </div>
    </div>
    
    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
    <div class="online-users-section">
      <div class="section-header">
        <span>åœ¨çº¿ç”¨æˆ·</span>
        <span class="online-count" id="onlineCount">0</span>
      </div>
      <div class="user-list" id="userList"></div>
    </div>
    
    <!-- èŠå¤©çª—å£ -->
    <div class="chat-section">
      <div class="section-header">èŠå¤©</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="200">
        <button class="chat-send-btn" id="chatSendBtn">å‘é€</button>
      </div>
    </div>
    
    <!-- åŠŸèƒ½æŒ‰é’® -->
    <div class="action-buttons">
      <button class="action-btn action-btn-primary" id="addPinBtn">â• æ·»åŠ å›¾é’‰</button>
      <button class="action-btn action-btn-secondary" id="resetPositionBtn">ğŸ“ è¿”å›åˆå§‹ä½ç½®</button>
    </div>
  </div>
  
  <!-- æ–‡å­—ä¿¡æ¯è¾“å…¥æ¡† -->
  <div id="pinEditor">
    <h3>æ·»åŠ å›¾é’‰ä¿¡æ¯</h3>
    <textarea id="pinTextInput" placeholder="è¯·è¾“å…¥å›¾é’‰çš„æ–‡å­—ä¿¡æ¯..."></textarea>
    
    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-section" id="uploadSection">
      <input type="file" id="imageInput" accept="image/*">
      <label for="imageInput" class="upload-label">ğŸ“· ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
    </div>
    <img id="imagePreview" class="image-preview" alt="é¢„è§ˆ">
    
    <div class="editor-buttons">
      <button id="cancelBtn">å–æ¶ˆ</button>
      <button id="publishBtn">å‘å¸ƒ</button>
    </div>
  </div>
  
  <!-- å›¾é’‰æ–‡å­—æµ®çª— -->
  <div id="pinPopup"></div>

  <script>
    // åˆå§‹åŒ–åœ°å›¾
    mapboxgl.accessToken = "pk.eyJ1IjoiZnVtb3RvIiwiYSI6ImNtYXhqbGZ4bDBiOWwybHB3a3R5dmk3Z2kifQ.vXgn2UF6HVT0cnnQRmLO1A";
    
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/fumoto/cmhmpsu1v000u01sr4tny40mj",
      center: [139.7006, 35.6896], // æ–°å®¿ç«™é™„è¿‘
      zoom: 14.1
    });

    // å­˜å‚¨æ‰€æœ‰å›¾é’‰
    const pins = [];
    const firebasePins = []; // å­˜å‚¨ Firebase å›¾é’‰
    let currentPopupPin = null; // å½“å‰æ˜¾ç¤ºæµ®çª—çš„å›¾é’‰
    let isPopupLocked = false; // æµ®çª—æ˜¯å¦è¢«ç‚¹å‡»é”å®š
    let currentUID = null; // å½“å‰ç”¨æˆ· UID
    let selectedImageFile = null; // é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶
    let isEditMode = false; // æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
    let editingPinKey = null; // æ­£åœ¨ç¼–è¾‘çš„å›¾é’‰ key
    
    // è·å– DOM å…ƒç´ 
    const backBtn = document.getElementById('backBtn');
    const pinEditor = document.getElementById('pinEditor');
    const pinTextInput = document.getElementById('pinTextInput');
    const pinPopup = document.getElementById('pinPopup');
    const publishBtn = document.getElementById('publishBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const mapOverlay = document.getElementById('mapOverlay');
    
    // é®ç½©å±‚ç›¸å…³å˜é‡
    let overlaySVG = null;
    let overlayDefs = null;
    let overlayMask = null;
    let overlayRect = null;
    const OVERLAY_DISTANCE_METERS = 280; // æœ¬åœ°å›¾é’‰å‘¨å›´é€æ˜åŒºåŸŸçš„åŠå¾„ï¼ˆç±³ï¼‰- å¯è°ƒæ•´æ­¤å€¼æ¥æ”¹å˜ç…§äº®èŒƒå›´
    const FIREBASE_OVERLAY_DISTANCE_METERS = 150; // Firebaseå›¾é’‰å‘¨å›´é€æ˜åŒºåŸŸçš„åŠå¾„ï¼ˆç±³ï¼‰
    
    // è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    // åˆå§‹åŒ–é®ç½©å±‚
    function initOverlay() {
      // åˆ›å»º SVG å…ƒç´ 
      overlaySVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      overlaySVG.setAttribute('width', '100%');
      overlaySVG.setAttribute('height', '100%');
      
      // åˆ›å»º defs
      overlayDefs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      
      // åˆ›å»ºæ¨¡ç³Šæ»¤é•œ
      // å¢å¤§æ»¤é•œèŒƒå›´ä»¥é¿å…ç¼©å°åœ°å›¾æ—¶çœ‹åˆ°æ¨¡ç³Šè¾¹ç•Œ
      // æ¨¡ç³Šæ•ˆæœä¼šå‘å¤–æ‰©å±•ï¼Œéœ€è¦è¶³å¤Ÿå¤§çš„èŒƒå›´æ¥è¦†ç›–
      const blurFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
      blurFilter.setAttribute('id', 'blurFilter');
      blurFilter.setAttribute('x', '-150%');
      blurFilter.setAttribute('y', '-150%');
      blurFilter.setAttribute('width', '400%');
      blurFilter.setAttribute('height', '400%');
      
      const feGaussianBlur = document.createElementNS('http://www.w3.org/2000/svg', 'feGaussianBlur');
      feGaussianBlur.setAttribute('in', 'SourceGraphic');
      feGaussianBlur.setAttribute('stdDeviation', '25'); // æ¨¡ç³Šç¨‹åº¦ï¼Œå¯ä»¥è°ƒæ•´æ­¤å€¼æ¥æ”¹å˜è¾¹ç¼˜æ¨¡ç³Šåº¦ï¼ˆæ•°å€¼è¶Šå¤§è¶Šæ¨¡ç³Šï¼‰
      
      blurFilter.appendChild(feGaussianBlur);
      overlayDefs.appendChild(blurFilter);
      
      // åˆ›å»º maskï¼ˆåœ¨ mask ä¸­ï¼Œé»‘è‰²è¡¨ç¤ºé€æ˜ï¼Œç™½è‰²è¡¨ç¤ºä¸é€æ˜ï¼‰
      overlayMask = document.createElementNS('http://www.w3.org/2000/svg', 'mask');
      overlayMask.setAttribute('id', 'pinMask');
      
      // åˆ›å»ºç™½è‰²èƒŒæ™¯ï¼ˆåœ¨ mask ä¸­ï¼Œç™½è‰²è¡¨ç¤ºä¸é€æ˜ï¼Œå³æ˜¾ç¤ºé®ç½©ï¼‰
      const maskRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      maskRect.setAttribute('width', '100%');
      maskRect.setAttribute('height', '100%');
      maskRect.setAttribute('fill', 'white'); // ç™½è‰² = ä¸é€æ˜ï¼ˆæ˜¾ç¤ºé®ç½©ï¼‰
      overlayMask.appendChild(maskRect);
      
      overlayDefs.appendChild(overlayMask);
      overlaySVG.appendChild(overlayDefs);
      
      // åˆ›å»ºé®ç½©å±‚çŸ©å½¢ï¼ˆä½¿ç”¨ maskï¼‰
      overlayRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      overlayRect.setAttribute('width', '100%');
      overlayRect.setAttribute('height', '100%');
      overlayRect.setAttribute('fill', 'rgba(0, 0, 0, 0.6)'); // é»‘è‰²åŠé€æ˜
      overlayRect.setAttribute('mask', 'url(#pinMask)');
      overlaySVG.appendChild(overlayRect);
      
      mapOverlay.appendChild(overlaySVG);
    }
    
    // è®¡ç®—æŒ‡å®šè·ç¦»ï¼ˆç±³ï¼‰å¯¹åº”çš„åƒç´ åŠå¾„
    function calculatePixelRadius(lngLat, distanceMeters) {
      // ä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹çš„çº¬åº¦æ¥è®¡ç®—
      const lat = lngLat[1];
      
      // è®¡ç®—ç»åº¦æ–¹å‘ä¸Šçš„åç§»ï¼ˆç±³è½¬åº¦ï¼‰
      // 1åº¦ç»åº¦åœ¨ä¸åŒçº¬åº¦çš„è·ç¦»ä¸åŒï¼Œè¿™é‡Œä½¿ç”¨è¿‘ä¼¼å€¼
      const metersPerDegreeLng = 111320 * Math.cos(lat * Math.PI / 180);
      const degreesLng = distanceMeters / metersPerDegreeLng;
      
      // è®¡ç®—çº¬åº¦æ–¹å‘ä¸Šçš„åç§»ï¼ˆç±³è½¬åº¦ï¼‰
      const metersPerDegreeLat = 111320;
      const degreesLat = distanceMeters / metersPerDegreeLat;
      
      // è®¡ç®—å›¾é’‰ä½ç½®å’Œåç§»ä½ç½®çš„åƒç´ åæ ‡
      const centerPoint = map.project(lngLat);
      const offsetPoint = map.project([lngLat[0] + degreesLng, lngLat[1]]);
      
      // è®¡ç®—åƒç´ è·ç¦»
      const pixelRadius = Math.abs(offsetPoint.x - centerPoint.x);
      
      return pixelRadius;
    }
    
    // æ›´æ–°é®ç½©å±‚
    function updateOverlay() {
      if (!overlayMask) return;
      
      // æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„åœ†å½¢ï¼ˆé™¤äº†ç™½è‰²èƒŒæ™¯çŸ©å½¢ï¼‰
      const existingCircles = overlayMask.querySelectorAll('circle');
      existingCircles.forEach(circle => circle.remove());
      
      // è·å–æ‰€æœ‰å›¾é’‰ï¼ˆæœ¬åœ°å›¾é’‰ + Firebaseå›¾é’‰ï¼‰
      const allPins = [...pins, ...firebasePins];
      
      // ä¸ºæ¯ä¸ªå›¾é’‰åˆ›å»ºåœ†å½¢é€æ˜åŒºåŸŸï¼ˆå¸¦æ¨¡ç³Šè¾¹ç¼˜ï¼‰
      allPins.forEach(pin => {
        if (!pin.lngLat) return;
        
        // åˆ¤æ–­æ˜¯æœ¬åœ°å›¾é’‰è¿˜æ˜¯ Firebase å›¾é’‰ï¼Œä½¿ç”¨ä¸åŒçš„ç…§äº®èŒƒå›´
        const isFirebasePin = pin.firebaseKey !== undefined;
        const distanceMeters = isFirebasePin ? FIREBASE_OVERLAY_DISTANCE_METERS : OVERLAY_DISTANCE_METERS;
        
        // è®¡ç®—åƒç´ åŠå¾„
        const pixelRadius = calculatePixelRadius(pin.lngLat, distanceMeters);
        
        // è·å–å›¾é’‰çš„åƒç´ åæ ‡ï¼ˆç›¸å¯¹äºåœ°å›¾å®¹å™¨ï¼‰
        // ç”±äºé®ç½©å±‚å’Œåœ°å›¾å®¹å™¨éƒ½æ˜¯ fixed å®šä½ä¸”è¦†ç›–æ•´ä¸ªå±å¹•ï¼Œåæ ‡å¯ä»¥ç›´æ¥ä½¿ç”¨
        const point = map.project(pin.lngLat);
        
        // åˆ›å»ºä¸€ä¸ª group æ¥åŒ…å«æ¨¡ç³Šçš„åœ†å½¢
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        group.setAttribute('filter', 'url(#blurFilter)'); // åº”ç”¨æ¨¡ç³Šæ•ˆæœåˆ°åœ†å½¢è¾¹ç¼˜
        
        // åˆ›å»ºé»‘è‰²åœ†å½¢ï¼ˆåœ¨ mask ä¸­ï¼Œé»‘è‰²è¡¨ç¤ºé€æ˜ï¼Œå³å›¾é’‰å‘¨å›´ä¸æ˜¾ç¤ºé®ç½©ï¼‰
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', point.x);
        circle.setAttribute('cy', point.y);
        circle.setAttribute('r', pixelRadius);
        circle.setAttribute('fill', 'black'); // é»‘è‰² = é€æ˜ï¼ˆå›¾é’‰å‘¨å›´ä¸æ˜¾ç¤ºé®ç½©ï¼‰
        
        group.appendChild(circle);
        overlayMask.appendChild(group);
      });
    }
    
    // ç­‰å¾… Firebase è®¤è¯å®Œæˆ
    window.addEventListener('firebaseAuthReady', () => {
      currentUID = window.currentUID;
      console.log('å½“å‰ç”¨æˆ· UID:', currentUID);
    });
    
    // å›¾ç‰‡é¢„è§ˆ
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          imagePreview.classList.add('show');
        };
        reader.readAsDataURL(file);
      }
    });
    
    // åˆ›å»ºæœ¬åœ°å›¾é’‰çš„å‡½æ•°ï¼ˆä½¿ç”¨ pin1-1.svgï¼‰
    function createLocalPin(lngLat, text = '') {
      // åˆ›å»ºéšè—çš„ Mapbox æ ‡è®°ç”¨äºåœ°ç†å®šä½
      const el = document.createElement('div');
      el.style.width = '1px';
      el.style.height = '1px';
      el.style.opacity = '0';
      el.style.pointerEvents = 'none';
      
      const marker = new mapboxgl.Marker({
        element: el,
        anchor: 'bottom'
      })
        .setLngLat(lngLat)
        .addTo(map);

      // åˆ›å»º SVG å›¾é’‰å…ƒç´ 
      const svgElement = document.createElement('div');
      svgElement.className = 'pin-svg';
      
      const svgImg = document.createElement('img');
      svgImg.src = 'img/pin1-1.svg';
      svgElement.appendChild(svgImg);
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(svgElement);

      // æ›´æ–°å›¾é’‰ä½ç½®çš„å‡½æ•°
      function updatePosition() {
        const point = map.project(lngLat);
        const container = map.getContainer();
        const rect = container.getBoundingClientRect();
        
        svgElement.style.left = (rect.left + point.x - 24) + 'px'; // 24px æ˜¯å®½åº¦çš„ä¸€åŠ
        svgElement.style.top = (rect.top + point.y - 48) + 'px'; // 48px æ˜¯é«˜åº¦ï¼Œé”šç‚¹åœ¨åº•éƒ¨
      }

      // ç›‘å¬åœ°å›¾äº‹ä»¶æ›´æ–°ä½ç½®
      map.on('move', updatePosition);
      map.on('zoom', updatePosition);
      map.on('resize', updatePosition);

      // åˆå§‹åŒ–ä½ç½®
      updatePosition();
      
      // æ·»åŠ å¼¹è·³å‡ºç°åŠ¨ç”» - 0 -> 1.3(å¤§) -> 0.9(å°) -> 1.05 -> 1(æ­£å¸¸)
      svgElement.style.animation = 'pinBounce 0.8s ease-out';
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤åŠ¨ç”»å±æ€§ï¼Œé¿å…å½±å“åç»­çš„äº¤äº’
      svgElement.addEventListener('animationend', () => {
        svgElement.style.animation = '';
      }, { once: true });

      // ä¿å­˜å›¾é’‰ä¿¡æ¯
      const pinData = {
        marker,
        svgElement,
        lngLat,
        text,
        updatePosition
      };

      // ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºæ–‡å­—æµ®çª—å¹¶å±…ä¸­
      svgElement.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('æœ¬åœ°å›¾é’‰è¢«ç‚¹å‡»:', text, lngLat);
        
        // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
        svgElement.style.transform = 'scale(1.2)';
        
        // å®šä¹‰ç¼©æ”¾åŒºé—´
        const minZoom = 14;
        const maxZoom = 15;
        const currentZoom = map.getZoom();
        
        // è®¡ç®—ç›®æ ‡ç¼©æ”¾å€¼
        let targetZoom;
        if (currentZoom < minZoom) {
          targetZoom = minZoom;
        } else if (currentZoom > maxZoom) {
          targetZoom = maxZoom;
        } else {
          targetZoom = currentZoom; // åœ¨åŒºé—´å†…ä¿æŒå½“å‰ç¼©æ”¾
        }
        
        // æ ¹æ®ç¼©æ”¾å·®å¼‚è°ƒæ•´åŠ¨ç”»å‚æ•°
        const zoomDiff = Math.abs(targetZoom - currentZoom);
        let duration, speed;
        
        if (zoomDiff === 0) {
          // åªéœ€è¦å¹³ç§»ï¼Œé€Ÿåº¦æœ€å¿«
          duration = 600;
          speed = 3;
        } else if (zoomDiff < 2) {
          // è½»å¾®ç¼©æ”¾
          duration = 800;
          speed = 2.5;
        } else if (zoomDiff < 4) {
          // ä¸­ç­‰ç¼©æ”¾
          duration = 1200;
          speed = 1.8;
        } else {
          // å¤§å¹…åº¦ç¼©æ”¾
          duration = 2000;
          speed = 1.2;
        }
        
        // ä»¥å›¾é’‰åæ ‡ä¸ºä¸­å¿ƒï¼Œè°ƒæ•´åˆ°ç›®æ ‡ç¼©æ”¾
        map.flyTo({
          center: lngLat,
          zoom: targetZoom,
          duration: duration,
          curve: 1.42,
          speed: speed
        });
        
        // æ˜¾ç¤ºæµ®çª—å¹¶é”å®š
        isPopupLocked = true;
        showPinPopup(pinData);
        
        // åŠ¨ç”»å®Œæˆåæ¢å¤å›¾é’‰å¤§å°
        setTimeout(() => {
          if (svgElement.getAttribute('_hover') === '1') {
            svgElement.style.transform = 'scale(1.3)';
          } else {
            svgElement.style.transform = 'scale(1)';
          }
        }, duration);
      });

      // é¼ æ ‡æ‚¬åœæ•ˆæœ
      svgElement.addEventListener('mouseenter', () => {
        svgElement.setAttribute('_hover', '1');
        if (svgElement.getAttribute('_active') !== '1') {
          // åˆ‡æ¢åˆ°æ›´å¿«çš„è¿‡æ¸¡ï¼Œç”¨äºäº¤äº’
          svgElement.style.transition = 'transform 0.3s ease';
          svgElement.style.transform = 'scale(1.3)';
        }
        // æ˜¾ç¤ºæµ®çª—ï¼ˆæ‚¬æµ®é¢„è§ˆæ¨¡å¼ï¼Œä¸é”å®šï¼‰
        if (!isPopupLocked) {
          showPinPopup(pinData);
        }
      });
      
      svgElement.addEventListener('mouseleave', () => {
        svgElement.setAttribute('_hover', '0');
        if (svgElement.getAttribute('_active') !== '1') {
          svgElement.style.transition = 'transform 0.3s ease';
          svgElement.style.transform = 'scale(1)';
        }
        // åªåœ¨æ‚¬æµ®é¢„è§ˆæ¨¡å¼ä¸‹å»¶è¿Ÿéšè—æµ®çª—
        if (!isPopupLocked) {
          setTimeout(() => {
            if (pinPopup.getAttribute('_hovering') !== '1' && !isPopupLocked) {
              hidePopup();
            }
          }, 100);
        }
      });
      
      // é¼ æ ‡æŒ‰ä¸‹æ•ˆæœ
      svgElement.addEventListener('mousedown', () => {
        svgElement.setAttribute('_active', '1');
        svgElement.style.transition = 'transform 0.1s ease';
        svgElement.style.transform = 'scale(0.92)';
      });
      
      svgElement.addEventListener('mouseup', () => {
        svgElement.setAttribute('_active', '0');
        svgElement.style.transition = 'transform 0.3s ease';
        if (svgElement.getAttribute('_hover') === '1') {
          svgElement.style.transform = 'scale(1.3)';
        } else {
          svgElement.style.transform = 'scale(1)';
        }
      });
      
      pins.push(pinData);
      
      // æ›´æ–°é®ç½©å±‚
      updateOverlay();
      
      return pinData;
    }
    
    // åˆ›å»º Firebase å›¾é’‰çš„å‡½æ•°ï¼ˆæ ¹æ®å†…å®¹åˆ‡æ¢å›¾æ ‡ï¼‰
    function createFirebasePin(lngLat, text = '', firebaseKey = null, uid = null, time = null, imageURL = null, likes = {}) {
      // åˆ›å»ºéšè—çš„ Mapbox æ ‡è®°ç”¨äºåœ°ç†å®šä½
      const el = document.createElement('div');
      el.style.width = '1px';
      el.style.height = '1px';
      el.style.opacity = '0';
      el.style.pointerEvents = 'none';
      
      const marker = new mapboxgl.Marker({
        element: el,
        anchor: 'bottom'
      })
        .setLngLat(lngLat)
        .addTo(map);

      // åˆ›å»º SVG å›¾é’‰å…ƒç´ ï¼ˆå‘å¸ƒå†…å®¹ä½¿ç”¨ä¸“ç”¨å›¾æ ‡ï¼Œä½¿ç”¨æ›´å°çš„å°ºå¯¸ï¼‰
      const svgElement = document.createElement('div');
      svgElement.className = 'pin-svg-firebase'; // ä½¿ç”¨æ›´å°çš„æ ·å¼ç±»
      
      const svgImg = document.createElement('img');
      svgElement.appendChild(svgImg);
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(svgElement);

      // æ›´æ–°å›¾é’‰ä½ç½®çš„å‡½æ•°ï¼ˆä½¿ç”¨æ›´å°çš„åç§»å€¼ï¼‰
      function updatePosition() {
        const point = map.project(lngLat);
        const container = map.getContainer();
        const rect = container.getBoundingClientRect();
        
        svgElement.style.left = (rect.left + point.x - 18) + 'px'; // 18px æ˜¯ 36px å®½åº¦çš„ä¸€åŠ
        svgElement.style.top = (rect.top + point.y - 36) + 'px'; // 36px æ˜¯é«˜åº¦ï¼Œé”šç‚¹åœ¨åº•éƒ¨
      }

      // ç›‘å¬åœ°å›¾äº‹ä»¶æ›´æ–°ä½ç½®
      map.on('move', updatePosition);
      map.on('zoom', updatePosition);
      map.on('resize', updatePosition);

      // åˆå§‹åŒ–ä½ç½®
      updatePosition();
      
      // æ·»åŠ å¼¹è·³å‡ºç°åŠ¨ç”» - 0 -> 1.3(å¤§) -> 0.9(å°) -> 1.05 -> 1(æ­£å¸¸)
      svgElement.style.animation = 'pinBounce 0.8s ease-out';
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤åŠ¨ç”»å±æ€§ï¼Œé¿å…å½±å“åç»­çš„äº¤äº’
      svgElement.addEventListener('animationend', () => {
        svgElement.style.animation = '';
      }, { once: true });

      // ä¿å­˜å›¾é’‰ä¿¡æ¯
      const pinData = {
        marker,
        svgElement,
        svgImg,
        lngLat,
        text,
        firebaseKey,
        uid,
        time,
        imageURL,
        likes: likes || {},
        updatePosition,
        updateIcon: () => {
          svgImg.src = pinData.imageURL ? 'img/pin2-2.svg' : 'img/pin2-1.svg';
        }
      };

      pinData.updateIcon();

      // ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºæ–‡å­—æµ®çª—å¹¶æ”¾å¤§
      svgElement.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('Firebaseå›¾é’‰è¢«ç‚¹å‡»:', text, lngLat);
        
        // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
        svgElement.style.transform = 'scale(1.2)';
        
        // å®šä¹‰ç¼©æ”¾åŒºé—´
        const minZoom = 14.2;
        const maxZoom = 15;
        const currentZoom = map.getZoom();
        
        // è®¡ç®—ç›®æ ‡ç¼©æ”¾å€¼
        let targetZoom;
        if (currentZoom < minZoom) {
          targetZoom = minZoom;
        } else if (currentZoom > maxZoom) {
          targetZoom = maxZoom;
        } else {
          targetZoom = currentZoom; // åœ¨åŒºé—´å†…ä¿æŒå½“å‰ç¼©æ”¾
        }
        
        // æ ¹æ®ç¼©æ”¾å·®å¼‚è°ƒæ•´åŠ¨ç”»å‚æ•°
        const zoomDiff = Math.abs(targetZoom - currentZoom);
        let duration, speed;
        
        if (zoomDiff === 0) {
          // åªéœ€è¦å¹³ç§»ï¼Œé€Ÿåº¦æœ€å¿«
          duration = 600;
          speed = 3;
        } else if (zoomDiff < 2) {
          // è½»å¾®ç¼©æ”¾
          duration = 800;
          speed = 2.5;
        } else if (zoomDiff < 4) {
          // ä¸­ç­‰ç¼©æ”¾
          duration = 1200;
          speed = 1.8;
        } else {
          // å¤§å¹…åº¦ç¼©æ”¾
          duration = 2000;
          speed = 1.2;
        }
        
        // ä»¥å›¾é’‰åæ ‡ä¸ºä¸­å¿ƒï¼Œè°ƒæ•´åˆ°ç›®æ ‡ç¼©æ”¾
        map.flyTo({
          center: lngLat,
          zoom: targetZoom,
          duration: duration,
          curve: 1.42,
          speed: speed
        });
        
        // æ˜¾ç¤ºæµ®çª—å¹¶é”å®š
        isPopupLocked = true;
        showPinPopup(pinData);
        
        // åŠ¨ç”»å®Œæˆåæ¢å¤å›¾é’‰å¤§å°
        setTimeout(() => {
          if (svgElement.getAttribute('_hover') === '1') {
            svgElement.style.transform = 'scale(1.3)';
          } else {
            svgElement.style.transform = 'scale(1)';
          }
        }, duration);
      });

      // é¼ æ ‡æ‚¬åœæ•ˆæœ
      svgElement.addEventListener('mouseenter', () => {
        svgElement.setAttribute('_hover', '1');
        if (svgElement.getAttribute('_active') !== '1') {
          // åˆ‡æ¢åˆ°æ›´å¿«çš„è¿‡æ¸¡ï¼Œç”¨äºäº¤äº’
          svgElement.style.transition = 'transform 0.3s ease';
          svgElement.style.transform = 'scale(1.3)';
        }
        // æ˜¾ç¤ºæµ®çª—ï¼ˆæ‚¬æµ®é¢„è§ˆæ¨¡å¼ï¼Œä¸é”å®šï¼‰
        if (!isPopupLocked) {
          showPinPopup(pinData);
        }
      });
      
      svgElement.addEventListener('mouseleave', () => {
        svgElement.setAttribute('_hover', '0');
        if (svgElement.getAttribute('_active') !== '1') {
          svgElement.style.transition = 'transform 0.3s ease';
          svgElement.style.transform = 'scale(1)';
        }
        // åªåœ¨æ‚¬æµ®é¢„è§ˆæ¨¡å¼ä¸‹å»¶è¿Ÿéšè—æµ®çª—
        if (!isPopupLocked) {
          setTimeout(() => {
            if (pinPopup.getAttribute('_hovering') !== '1' && !isPopupLocked) {
              hidePopup();
            }
          }, 100);
        }
      });
      
      // é¼ æ ‡æŒ‰ä¸‹æ•ˆæœ
      svgElement.addEventListener('mousedown', () => {
        svgElement.setAttribute('_active', '1');
        svgElement.style.transition = 'transform 0.1s ease';
        svgElement.style.transform = 'scale(0.92)';
      });
      
      svgElement.addEventListener('mouseup', () => {
        svgElement.setAttribute('_active', '0');
        svgElement.style.transition = 'transform 0.3s ease';
        if (svgElement.getAttribute('_hover') === '1') {
          svgElement.style.transform = 'scale(1.3)';
        } else {
          svgElement.style.transform = 'scale(1)';
        }
      });
      
      firebasePins.push(pinData);
      
      // æ›´æ–°é®ç½©å±‚
      updateOverlay();
      
      return pinData;
    }
    
    // æ˜¾ç¤ºå›¾é’‰æ–‡å­—æµ®çª—
    function showPinPopup(pinData) {
      if (!pinData.text && !pinData.imageURL) return; // å¦‚æœæ²¡æœ‰æ–‡å­—å’Œå›¾ç‰‡åˆ™ä¸æ˜¾ç¤º
      
      currentPopupPin = pinData;
      
      // æ¸…ç©ºæµ®çª—å†…å®¹
      pinPopup.innerHTML = '';
      
      // æ·»åŠ å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
      if (pinData.imageURL) {
        const img = document.createElement('img');
        img.src = pinData.imageURL;
        img.className = 'popup-image';
        pinPopup.appendChild(img);
      }
      
      // æ·»åŠ æ–‡å­—
      if (pinData.text) {
        const textDiv = document.createElement('div');
        textDiv.textContent = pinData.text;
        pinPopup.appendChild(textDiv);
      }
      
      // åˆ›å»ºåº•éƒ¨ä¿¡æ¯æ ï¼ˆæ—¶é—´+ç‚¹èµï¼‰
      if (pinData.firebaseKey && (pinData.time || true)) {
        const footerDiv = document.createElement('div');
        footerDiv.className = 'popup-footer';
        
        // æ·»åŠ æ—¶é—´ï¼ˆå¦‚æœæœ‰ï¼‰
        if (pinData.time) {
          const timeDiv = document.createElement('div');
          timeDiv.className = 'popup-time';
          const date = new Date(pinData.time);
          timeDiv.textContent = 'å‘å¸ƒäº ' + date.toLocaleString('ja-JP');
          footerDiv.appendChild(timeDiv);
        } else {
          // å ä½å…ƒç´ ï¼Œä¿æŒå¸ƒå±€
          const placeholder = document.createElement('div');
          footerDiv.appendChild(placeholder);
        }
        
        // æ·»åŠ ç‚¹èµåŠŸèƒ½
        const likeDiv = document.createElement('div');
        likeDiv.className = 'popup-like';
        
        // è®¡ç®—ç‚¹èµæ•°
        const likes = pinData.likes || {};
        const likeTotal = Object.keys(likes).length;
        
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
        const hasLiked = currentUID && likes[currentUID];
        
        // å¦‚æœæ˜¯è‡ªå·±ç‚¹çš„èµï¼Œæ˜¾ç¤º"ã„ã„ã­!"æ–‡å­—
        if (hasLiked) {
          const likeText = document.createElement('span');
          likeText.className = 'like-text';
          likeText.textContent = 'ã„ã„ã­!';
          likeDiv.appendChild(likeText);
        }
        
        // ç‚¹èµå›¾æ ‡
        const likeIcon = document.createElement('span');
        likeIcon.className = 'like-icon';
        const likeImg = document.createElement('img');
        likeImg.src = hasLiked ? 'img/zan02.svg' : 'img/zan01.svg';
        likeIcon.appendChild(likeImg);
        likeDiv.appendChild(likeIcon);
        
        // ç‚¹èµæ•°ï¼ˆåªåœ¨æœ‰èµæ—¶æ˜¾ç¤ºï¼‰
        if (likeTotal > 0) {
          const likeCount = document.createElement('span');
          likeCount.className = 'like-count';
          likeCount.textContent = likeTotal;
          likeDiv.appendChild(likeCount);
        }
        
        // ç‚¹èµäº‹ä»¶
        likeDiv.onclick = async (e) => {
          e.stopPropagation();
          await toggleLike(pinData, likeDiv);
        };
        
        footerDiv.appendChild(likeDiv);
        pinPopup.appendChild(footerDiv);
      }
      
      // å¦‚æœæ˜¯è‡ªå·±çš„å›¾é’‰ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
      if (pinData.uid && currentUID && pinData.uid === currentUID && pinData.firebaseKey) {
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'popup-buttons';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'popup-btn edit-btn';
        editBtn.textContent = 'ç¼–è¾‘';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          editPin(pinData);
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'popup-btn delete-btn';
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deletePin(pinData);
        };
        
        buttonsDiv.appendChild(editBtn);
        buttonsDiv.appendChild(deleteBtn);
        pinPopup.appendChild(buttonsDiv);
      }
      
      // å…ˆæ›´æ–°ä½ç½®ï¼Œå†æ˜¾ç¤ºï¼ˆé¿å…é—ªç°ï¼‰
      updatePopupPosition();
      
      // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ä½ç½®æ›´æ–°åå†æ˜¾ç¤º
      requestAnimationFrame(() => {
        pinPopup.classList.add('show');
      });
    }
    
    // éšè—å›¾é’‰æ–‡å­—æµ®çª—
    function hidePopup() {
      pinPopup.classList.remove('show');
      currentPopupPin = null;
    }
    
    // ç¼–è¾‘å›¾é’‰
    function editPin(pinData) {
      isPopupLocked = false;
      hidePopup();
      
      // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
      isEditMode = true;
      editingPinKey = pinData.firebaseKey;
      
      // å¡«å……å½“å‰å†…å®¹
      pinTextInput.value = pinData.text || '';
      
      // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºé¢„è§ˆ
      if (pinData.imageURL) {
        imagePreview.src = pinData.imageURL;
        imagePreview.classList.add('show');
      }
      
      // æ˜¾ç¤ºç¼–è¾‘å™¨
      pinEditor.classList.add('show');
      pinTextInput.focus();
      
      // ä¿®æ”¹æ ‡é¢˜
      const title = pinEditor.querySelector('h3');
      title.textContent = 'ç¼–è¾‘å›¾é’‰ä¿¡æ¯';
    }
    
    // åˆ é™¤å›¾é’‰
    function deletePin(pinData) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå›¾é’‰å—ï¼Ÿ')) {
        return;
      }
      
      isPopupLocked = false;
      hidePopup();
      
      // ä» Firebase åˆ é™¤
      const pinRef = window.firebaseRef(window.firebaseDatabase, 'pins/' + pinData.firebaseKey);
      window.firebaseRemove(pinRef)
        .then(() => {
          console.log('å›¾é’‰å·²åˆ é™¤');
        })
        .catch((error) => {
          console.error('åˆ é™¤å¤±è´¥:', error);
          alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    // åˆ‡æ¢ç‚¹èµçŠ¶æ€
    async function toggleLike(pinData, likeDiv) {
      if (!currentUID) {
        alert('æ­£åœ¨ç™»å½•ä¸­ï¼Œè¯·ç¨å€™...');
        return;
      }
      
      if (!pinData.firebaseKey) {
        return;
      }
      
      const likes = pinData.likes || {};
      const hasLiked = likes[currentUID];
      
      try {
        if (hasLiked) {
          // å–æ¶ˆç‚¹èµ
          const likeRef = window.firebaseRef(window.firebaseDatabase, 'pins/' + pinData.firebaseKey + '/likes/' + currentUID);
          await window.firebaseRemove(likeRef);
          delete pinData.likes[currentUID];
          console.log('ğŸ’” å–æ¶ˆç‚¹èµ');
        } else {
          // ç‚¹èµ
          const likesRef = window.firebaseRef(window.firebaseDatabase, 'pins/' + pinData.firebaseKey + '/likes');
          const updateData = {};
          updateData[currentUID] = true;
          await window.firebaseUpdate(likesRef, updateData);
          pinData.likes[currentUID] = true;
          console.log('â¤ï¸ ç‚¹èµæˆåŠŸ');
        }
        
        // é‡æ–°æ„å»ºç‚¹èµåŒºåŸŸ
        const likeTotal = Object.keys(pinData.likes).length;
        const newHasLiked = pinData.likes[currentUID];
        
        likeDiv.innerHTML = '';
        
        // å¦‚æœæ˜¯è‡ªå·±ç‚¹çš„èµï¼Œæ˜¾ç¤º"ã„ã„ã­!"æ–‡å­—
        if (newHasLiked) {
          const likeText = document.createElement('span');
          likeText.className = 'like-text';
          likeText.textContent = 'ã„ã„ã­!';
          likeDiv.appendChild(likeText);
        }
        
        // ç‚¹èµå›¾æ ‡
        const likeIcon = document.createElement('span');
        likeIcon.className = 'like-icon';
        if (newHasLiked) {
          likeIcon.classList.add('liked');
        }
        const likeImg = document.createElement('img');
        likeImg.src = newHasLiked ? 'img/zan02.svg' : 'img/zan01.svg';
        likeIcon.appendChild(likeImg);
        likeDiv.appendChild(likeIcon);
        
        // ç‚¹èµæ•°ï¼ˆåªåœ¨æœ‰èµæ—¶æ˜¾ç¤ºï¼‰
        if (likeTotal > 0) {
          const likeCount = document.createElement('span');
          likeCount.className = 'like-count';
          likeCount.textContent = likeTotal;
          likeDiv.appendChild(likeCount);
        }
        
      } catch (error) {
        console.error('âŒ ç‚¹èµæ“ä½œå¤±è´¥:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // æ›´æ–°æµ®çª—ä½ç½®
    function updatePopupPosition() {
      if (!currentPopupPin) return;
      
      const point = map.project(currentPopupPin.lngLat);
      const container = map.getContainer();
      const rect = container.getBoundingClientRect();
      
      // æµ®çª—æ˜¾ç¤ºåœ¨å›¾é’‰ä¸Šæ–¹ï¼Œåç§» 120pxï¼ˆå›¾é’‰é«˜åº¦ + æ›´å¤šé—´è·ï¼‰
      // åªè®¾ç½® left å’Œ topï¼Œtransform ç”± CSS æ§åˆ¶ï¼ˆå±…ä¸­å’ŒåŠ¨ç”»ï¼‰
      pinPopup.style.left = (rect.left + point.x) + 'px';
      pinPopup.style.top = (rect.top + point.y - 70) + 'px';
    }
    
    // ç›‘å¬åœ°å›¾ç§»åŠ¨æ›´æ–°æµ®çª—ä½ç½®
    map.on('move', () => {
      updatePopupPosition();
      updateOverlay();
    });
    map.on('zoom', () => {
      updatePopupPosition();
      updateOverlay();
    });
    map.on('resize', () => {
      updateOverlay();
    });
    
    // æµ®çª—é¼ æ ‡äº‹ä»¶ - é˜²æ­¢é¼ æ ‡ç§»åˆ°æµ®çª—ä¸Šæ—¶æ¶ˆå¤±
    pinPopup.addEventListener('mouseenter', () => {
      // æ ‡è®°æµ®çª—æ­£åœ¨è¢«æ‚¬æµ®
      pinPopup.setAttribute('_hovering', '1');
    });
    
    pinPopup.addEventListener('mouseleave', () => {
      // é¼ æ ‡ç¦»å¼€æµ®çª—æ—¶ï¼Œåªåœ¨æ‚¬æµ®é¢„è§ˆæ¨¡å¼ä¸‹éšè—
      pinPopup.setAttribute('_hovering', '0');
      if (!isPopupLocked) {
        hidePopup();
      }
    });

    // æ·»åŠ å›¾é’‰æ¨¡å¼
    let isAddingPin = false;
    let pendingPinLocation = null; // å¾…æ·»åŠ å›¾é’‰çš„ä½ç½®
    const addBtn = document.getElementById("addPinBtn");

    addBtn.addEventListener("click", () => {
      isAddingPin = !isAddingPin;
      
      if (isAddingPin) {
        addBtn.textContent = "ğŸŸ¢ ç‚¹å‡»åœ°å›¾æ”¾ç½®å›¾é’‰";
        addBtn.classList.add("active");
        map.getCanvas().style.cursor = 'crosshair';
      } else {
        addBtn.textContent = "â• æ·»åŠ å›¾é’‰";
        addBtn.classList.remove("active");
        map.getCanvas().style.cursor = '';
      }
    });

    // ç‚¹å‡»åœ°å›¾æ—¶çš„å¤„ç†
    map.on("click", (e) => {
      // å¦‚æœæ­£åœ¨æ·»åŠ å›¾é’‰æ¨¡å¼ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
      if (isAddingPin) {
        pendingPinLocation = [e.lngLat.lng, e.lngLat.lat];
        console.log("é€‰æ‹©å›¾é’‰ä½ç½®:", pendingPinLocation);
        
        // æ˜¾ç¤ºè¾“å…¥æ¡†
        pinEditor.classList.add('show');
        pinTextInput.value = '';
        pinTextInput.focus();
        
        // é€€å‡ºæ·»åŠ æ¨¡å¼
        isAddingPin = false;
        addBtn.textContent = "â• æ·»åŠ å›¾é’‰";
        addBtn.classList.remove("active");
        map.getCanvas().style.cursor = '';
      } else {
        // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹ï¼Œéšè—æµ®çª—å¹¶è§£é”
        isPopupLocked = false;
        hidePopup();
      }
    });
    
    // å‘å¸ƒæŒ‰é’® - åˆ›å»º/ç¼–è¾‘å›¾é’‰å¹¶ä¿å­˜åˆ° Firebase
    publishBtn.addEventListener('click', async () => {
      const text = pinTextInput.value.trim();
      
      if (!text && !selectedImageFile) {
        alert('è¯·è¾“å…¥æ–‡å­—ä¿¡æ¯æˆ–ä¸Šä¼ å›¾ç‰‡');
        return;
      }
      
      if (!currentUID) {
        alert('æ­£åœ¨ç™»å½•ä¸­ï¼Œè¯·ç¨å€™...');
        return;
      }
      
      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      publishBtn.disabled = true;
      const originalText = publishBtn.textContent;
      publishBtn.textContent = selectedImageFile ? 'ä¸Šä¼ ä¸­...' : 'å‘å¸ƒä¸­...';
      
      try {
        // ç¼–è¾‘æ¨¡å¼
        if (isEditMode && editingPinKey) {
          let imageURL = imagePreview.src.startsWith('http') ? imagePreview.src : null;
          
          // å¦‚æœé€‰æ‹©äº†æ–°å›¾ç‰‡ï¼Œä¸Šä¼ 
          if (selectedImageFile) {
            console.log('ğŸ“¸ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...');
            console.log('æ–‡ä»¶å:', selectedImageFile.name);
            console.log('æ–‡ä»¶å¤§å°:', (selectedImageFile.size / 1024).toFixed(2), 'KB');
            
            const fileName = Date.now() + '_' + selectedImageFile.name;
            const storageReference = window.firebaseStorageRef(window.firebaseStorage, 'pins/' + fileName);
            
            console.log('â¬†ï¸ ä¸Šä¼ åˆ° Storage...');
            await window.firebaseUploadBytes(storageReference, selectedImageFile);
            
            console.log('ğŸ”— è·å–ä¸‹è½½é“¾æ¥...');
            imageURL = await window.firebaseGetDownloadURL(storageReference);
            console.log('âœ… å›¾ç‰‡å·²ä¸Šä¼ :', imageURL);
          }
          
          // æ›´æ–° Firebase
          const pinRef = window.firebaseRef(window.firebaseDatabase, 'pins/' + editingPinKey);
          const updateData = {
            text: text
          };
          
          if (imageURL) {
            updateData.imageURL = imageURL;
          }
          
          await window.firebaseUpdate(pinRef, updateData);
          console.log('âœ… å›¾é’‰å·²æ›´æ–°');
          
          // æ¸…ç†
          resetEditor();
        } 
        // æ–°å»ºæ¨¡å¼
        else if (pendingPinLocation) {
          console.log("ğŸ“ åˆ›å»ºæ–°å›¾é’‰:", pendingPinLocation);
          
          let imageURL = null;
          
          // å¦‚æœé€‰æ‹©äº†å›¾ç‰‡ï¼Œä¸Šä¼ åˆ° Firebase Storage
          if (selectedImageFile) {
            console.log('ğŸ“¸ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...');
            console.log('æ–‡ä»¶å:', selectedImageFile.name);
            console.log('æ–‡ä»¶å¤§å°:', (selectedImageFile.size / 1024).toFixed(2), 'KB');
            console.log('æ–‡ä»¶ç±»å‹:', selectedImageFile.type);
            
            const fileName = Date.now() + '_' + selectedImageFile.name;
            const storageReference = window.firebaseStorageRef(window.firebaseStorage, 'pins/' + fileName);
            
            console.log('â¬†ï¸ ä¸Šä¼ åˆ° Storage è·¯å¾„:', 'pins/' + fileName);
            await window.firebaseUploadBytes(storageReference, selectedImageFile);
            
            console.log('ğŸ”— è·å–ä¸‹è½½é“¾æ¥...');
            imageURL = await window.firebaseGetDownloadURL(storageReference);
            console.log('âœ… å›¾ç‰‡å·²ä¸Šä¼ æˆåŠŸ:', imageURL);
          }
          
          // ä¿å­˜åˆ° Firebase Realtime Database
          const pinsRef = window.firebaseRef(window.firebaseDatabase, 'pins');
          const newPinData = {
            lng: pendingPinLocation[0],
            lat: pendingPinLocation[1],
            text: text,
            uid: currentUID,
            time: Date.now()
          };
          
          if (imageURL) {
            newPinData.imageURL = imageURL;
          }
          
          console.log('ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“:', newPinData);
          await window.firebasePush(pinsRef, newPinData);
          console.log('âœ… å›¾é’‰å·²ä¿å­˜åˆ° Firebase');
          
          // æ¸…ç†
          resetEditor();
        }
      } catch (error) {
        console.error('âŒ æ“ä½œå¤±è´¥:', error);
        console.error('é”™è¯¯ä»£ç :', error.code);
        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
        
        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“å»ºè®®
        let errorMsg = 'æ“ä½œå¤±è´¥: ' + error.message;
        
        if (error.code === 'storage/unauthorized') {
          errorMsg = 'âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼šæƒé™ä¸è¶³\n\nè¯·åœ¨ Firebase æ§åˆ¶å°è®¾ç½® Storage è§„åˆ™ï¼š\n\nrules_version = \'2\';\nservice firebase.storage {\n  match /b/{bucket}/o {\n    match /pins/{allPaths=**} {\n      allow read: if true;\n      allow write: if request.auth != null;\n    }\n  }\n}';
        } else if (error.code === 'storage/canceled') {
          errorMsg = 'âŒ ä¸Šä¼ å·²å–æ¶ˆ';
        } else if (error.code === 'storage/unknown') {
          errorMsg = 'âŒ æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
        }
        
        alert(errorMsg);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        publishBtn.disabled = false;
        publishBtn.textContent = originalText;
      }
    });
    
    // é‡ç½®ç¼–è¾‘å™¨
    function resetEditor() {
      pinEditor.classList.remove('show');
      pinTextInput.value = '';
      imageInput.value = '';
      imagePreview.src = '';
      imagePreview.classList.remove('show');
      selectedImageFile = null;
      pendingPinLocation = null;
      isEditMode = false;
      editingPinKey = null;
      
      // æ¢å¤æ ‡é¢˜
      const title = pinEditor.querySelector('h3');
      title.textContent = 'æ·»åŠ å›¾é’‰ä¿¡æ¯';
    }
    
    // å–æ¶ˆæŒ‰é’®
    cancelBtn.addEventListener('click', () => {
      resetEditor();
    });

    // å°†base64è½¬æ¢ä¸ºFileå¯¹è±¡
    function dataURLtoFile(dataurl, filename) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], filename, { type: mime });
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªpå›¾é¡µçš„å›¾ç‰‡
    function checkPendingMapPost() {
      const pendingImage = localStorage.getItem('pendingMapPostImage');
      const pendingSource = localStorage.getItem('pendingMapPostSource');
      
      if (pendingImage && pendingSource === 'album-ps') {
        console.log('æ£€æµ‹åˆ°æ¥è‡ªpå›¾é¡µçš„å›¾ç‰‡ï¼Œè‡ªåŠ¨è¿›å…¥æ·»åŠ å›¾é’‰æ¨¡å¼');
        
        // å°†base64è½¬æ¢ä¸ºFileå¯¹è±¡
        const imageFile = dataURLtoFile(pendingImage, 'edited-image-' + Date.now() + '.png');
        selectedImageFile = imageFile;
        
        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        imagePreview.src = pendingImage;
        imagePreview.classList.add('show');
        
        // è‡ªåŠ¨æ¿€æ´»æ·»åŠ å›¾é’‰æ¨¡å¼
        isAddingPin = true;
        addBtn.textContent = "ğŸŸ¢ ç‚¹å‡»åœ°å›¾æ”¾ç½®å›¾é’‰";
        addBtn.classList.add("active");
        map.getCanvas().style.cursor = 'crosshair';
        
        // æ¸…ç†localStorage
        localStorage.removeItem('pendingMapPostImage');
        localStorage.removeItem('pendingMapPostSource');
        
        // æç¤ºç”¨æˆ·
        setTimeout(() => {
          alert('å›¾ç‰‡å·²åŠ è½½ï¼è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©å›¾é’‰ä½ç½®ï¼Œç„¶åæ·»åŠ æ–‡å­—ä¿¡æ¯ã€‚');
        }, 500);
      }
    }

    // åœ°å›¾åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–æœ¬åœ°å›¾é’‰å’Œ Firebase ç›‘å¬
    map.on('load', () => {
      // åˆå§‹åŒ–é®ç½©å±‚
      initOverlay();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘å¸ƒçš„å›¾ç‰‡
      checkPendingMapPost();
      
      // åˆ›å»ºæœ¬åœ°å›¾é’‰ï¼ˆä½¿ç”¨ map01.svgï¼‰- æ–°å®¿ç«™åæ ‡
      const shinjukuStation = [139.7006, 35.6896];
      createLocalPin(shinjukuStation, 'æ–°å®¿ç«™');
      console.log('å·²åœ¨æ–°å®¿ç«™æ·»åŠ æœ¬åœ°æµ‹è¯•å›¾é’‰ï¼ˆpin1-1.svgï¼‰');
      
      // åˆå§‹åŒ–é®ç½©å±‚
      updateOverlay();
      
      // åˆå§‹åŒ– Firebase ç›‘å¬å™¨ï¼ˆä½¿ç”¨ map02.svgï¼‰
      const pinsRef = window.firebaseRef(window.firebaseDatabase, 'pins');
      
      // ç›‘å¬æ–°å¢çš„å›¾é’‰
      window.firebaseOnChildAdded(pinsRef, (snapshot) => {
        const data = snapshot.val();
        const key = snapshot.key;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥å›¾é’‰ï¼ˆé¿å…é‡å¤ï¼‰
        const exists = firebasePins.some(pin => pin.firebaseKey === key);
        if (!exists && data.lng && data.lat) {
          const lngLat = [data.lng, data.lat];
          createFirebasePin(
            lngLat, 
            data.text || '', 
            key, 
            data.uid || null, 
            data.time || null, 
            data.imageURL || null,
            data.likes || {}
          );
          console.log('ä» Firebase åŠ è½½å›¾é’‰ï¼ˆmap02.svgï¼‰:', data.text, lngLat);
        }
      });
      
      // ç›‘å¬åˆ é™¤çš„å›¾é’‰
      window.firebaseOnChildRemoved(pinsRef, (snapshot) => {
        const key = snapshot.key;
        
        // æŸ¥æ‰¾å¹¶åˆ é™¤å¯¹åº”çš„å›¾é’‰
        const pinIndex = firebasePins.findIndex(pin => pin.firebaseKey === key);
        if (pinIndex !== -1) {
          const pin = firebasePins[pinIndex];
          
          // ç§»é™¤æ ‡è®°å’Œ SVG å…ƒç´ 
          pin.marker.remove();
          if (pin.svgElement && pin.svgElement.parentNode) {
            pin.svgElement.parentNode.removeChild(pin.svgElement);
          }
          
          // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æµ®çª—æ˜¯è¿™ä¸ªå›¾é’‰ï¼Œéšè—æµ®çª—
          if (currentPopupPin && currentPopupPin.firebaseKey === key) {
            hidePopup();
          }
          
          // ä»æ•°ç»„ä¸­ç§»é™¤
          firebasePins.splice(pinIndex, 1);
          console.log('å·²åˆ é™¤ Firebase å›¾é’‰:', key);
          
          // æ›´æ–°é®ç½©å±‚
          updateOverlay();
        }
      });
      
      // ç›‘å¬å›¾é’‰æ›´æ–°
      window.firebaseOnChildChanged(pinsRef, (snapshot) => {
        const data = snapshot.val();
        const key = snapshot.key;
        
        // æŸ¥æ‰¾å¯¹åº”çš„å›¾é’‰å¹¶æ›´æ–°
        const pin = firebasePins.find(p => p.firebaseKey === key);
        if (pin) {
          pin.text = data.text || '';
          pin.imageURL = data.imageURL || null;
          pin.time = data.time || null;
          pin.likes = data.likes || {};
          if (pin.updateIcon) {
            pin.updateIcon();
          }
          
          // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æµ®çª—æ˜¯è¿™ä¸ªå›¾é’‰ï¼Œæ›´æ–°æµ®çª—å†…å®¹
          if (currentPopupPin && currentPopupPin.firebaseKey === key) {
            showPinPopup(pin);
          }
          
          console.log('å›¾é’‰å·²æ›´æ–°:', key);
        }
      });
      
      console.log('Firebase ç›‘å¬å™¨å·²åˆå§‹åŒ–');
    });
    
    // ========== ä¾§è¾¹æ åŠŸèƒ½ ==========
    
    // è·å–ç”¨æˆ·IPåœ°å€
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('è·å–IPå¤±è´¥:', error);
        return '127.0.0.1';
      }
    }
    
    // éšæœºemoji
    const emojis = ['ğŸ‘¤', 'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤©'];
    let userEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
    async function initUserInfo() {
      const userIP = await getUserIP();
      document.getElementById('userIP').textContent = userIP;
      document.getElementById('userEmoji').textContent = userEmoji;
      
      // å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°Firebase
      if (currentUID) {
        const userRef = window.firebaseRef(window.firebaseDatabase, 'users/' + currentUID);
        window.firebaseUpdate(userRef, {
          ip: userIP,
          emoji: userEmoji,
          lastSeen: Date.now()
        });
      }
    }
    
    // åœ¨çº¿ç”¨æˆ·ç®¡ç†
    let onlineUsers = {};
    
    function updateOnlineUsers() {
      const userList = document.getElementById('userList');
      const onlineCount = document.getElementById('onlineCount');
      
      // æ¸…ç©ºåˆ—è¡¨
      userList.innerHTML = '';
      
      // æ›´æ–°åœ¨çº¿äººæ•°
      const count = Object.keys(onlineUsers).length;
      onlineCount.textContent = count;
      
      // æ·»åŠ ç”¨æˆ·åˆ°åˆ—è¡¨
      Object.entries(onlineUsers).forEach(([uid, userData]) => {
        const item = document.createElement('div');
        item.className = 'user-list-item';
        
        const emoji = document.createElement('div');
        emoji.className = 'user-emoji';
        emoji.textContent = userData.emoji || 'ğŸ‘¤';
        
        const ip = document.createElement('div');
        ip.className = 'user-ip';
        ip.textContent = userData.ip || 'æœªçŸ¥';
        
        item.appendChild(emoji);
        item.appendChild(ip);
        userList.appendChild(item);
      });
    }
    
    // ç›‘å¬åœ¨çº¿ç”¨æˆ·å˜åŒ–
    function initOnlineUsers() {
      if (!window.firebaseDatabase || !currentUID) {
        setTimeout(initOnlineUsers, 100);
        return;
      }
      
      const usersRef = window.firebaseRef(window.firebaseDatabase, 'users');
      
      // ç›‘å¬ç”¨æˆ·åŠ å…¥
      window.firebaseOnChildAdded(usersRef, (snapshot) => {
        const userData = snapshot.val();
        if (userData && snapshot.key !== currentUID) {
          onlineUsers[snapshot.key] = userData;
          updateOnlineUsers();
        }
      });
      
      // ç›‘å¬ç”¨æˆ·æ›´æ–°
      window.firebaseOnChildChanged(usersRef, (snapshot) => {
        const userData = snapshot.val();
        if (userData && snapshot.key !== currentUID) {
          onlineUsers[snapshot.key] = userData;
          updateOnlineUsers();
        }
      });
      
      // ç›‘å¬ç”¨æˆ·ç¦»å¼€ï¼ˆèŠ‚ç‚¹åˆ é™¤ï¼‰
      window.firebaseOnChildRemoved(usersRef, (snapshot) => {
        if (snapshot.key !== currentUID && onlineUsers[snapshot.key]) {
          delete onlineUsers[snapshot.key];
          updateOnlineUsers();
        }
      });
      
      // ç›‘å¬ç”¨æˆ·ç¦»å¼€ï¼ˆé€šè¿‡å®šæœŸæ£€æŸ¥lastSeenï¼Œä½œä¸ºå¤‡ç”¨æœºåˆ¶ï¼‰
      setInterval(() => {
        const now = Date.now();
        const timeout = 30000; // 30ç§’æœªæ›´æ–°è§†ä¸ºç¦»çº¿
        
        Object.keys(onlineUsers).forEach(uid => {
          if (uid !== currentUID && onlineUsers[uid].lastSeen) {
            if (now - onlineUsers[uid].lastSeen > timeout) {
              delete onlineUsers[uid];
              updateOnlineUsers();
            }
          }
        });
      }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
      
      // å®šæœŸæ›´æ–°è‡ªå·±çš„lastSeen
      setInterval(() => {
        if (currentUID) {
          const userRef = window.firebaseRef(window.firebaseDatabase, 'users/' + currentUID + '/lastSeen');
          window.firebaseUpdate(userRef, Date.now());
        }
      }, 15000); // æ¯15ç§’æ›´æ–°ä¸€æ¬¡
    }
    
    // èŠå¤©åŠŸèƒ½
    function initChat() {
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      const chatMessages = document.getElementById('chatMessages');
      
      // ç”¨äºè·Ÿè¸ªå·²æ˜¾ç¤ºçš„æ¶ˆæ¯ï¼Œé¿å…é‡å¤æ˜¾ç¤º
      const displayedMessages = new Set();
      
      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
      function addMessageToChat(msgData, messageKey) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡
        if (displayedMessages.has(messageKey)) {
          return;
        }
        displayedMessages.add(messageKey);
        
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        msgDiv.setAttribute('data-key', messageKey);
        
        const header = document.createElement('div');
        header.className = 'chat-message-header';
        
        const user = document.createElement('span');
        user.className = 'chat-message-user';
        user.textContent = `${msgData.emoji || 'ğŸ‘¤'} ${msgData.ip || 'æœªçŸ¥'}`;
        
        const time = document.createElement('span');
        time.className = 'chat-message-time';
        const date = new Date(msgData.time);
        time.textContent = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        
        header.appendChild(user);
        header.appendChild(time);
        
        const content = document.createElement('div');
        content.className = 'chat-message-content';
        content.textContent = msgData.message;
        
        msgDiv.appendChild(header);
        msgDiv.appendChild(content);
        chatMessages.appendChild(msgDiv);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // å‘é€æ¶ˆæ¯
      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || !currentUID) return;
        
        const chatRef = window.firebaseRef(window.firebaseDatabase, 'chat');
        window.firebasePush(chatRef, {
          uid: currentUID,
          emoji: userEmoji,
          ip: document.getElementById('userIP').textContent,
          message: message,
          time: Date.now()
        });
        
        chatInput.value = '';
      }
      
      chatSendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // ç›‘å¬æ–°æ¶ˆæ¯ï¼ˆåŒ…æ‹¬å†å²æ¶ˆæ¯ï¼‰
      const chatRef = window.firebaseRef(window.firebaseDatabase, 'chat');
      window.firebaseOnChildAdded(chatRef, (snapshot) => {
        const msgData = snapshot.val();
        if (!msgData) return;
        
        addMessageToChat(msgData, snapshot.key);
      });
      
      // ç›‘å¬æ¶ˆæ¯åˆ é™¤
      window.firebaseOnChildRemoved(chatRef, (snapshot) => {
        const messageKey = snapshot.key;
        displayedMessages.delete(messageKey);
        
        // ä»DOMä¸­ç§»é™¤
        const msgElement = chatMessages.querySelector(`[data-key="${messageKey}"]`);
        if (msgElement) {
          msgElement.remove();
        }
      });
    }
    
    // è¿”å›åˆå§‹ä½ç½®
    function initResetPosition() {
      const resetBtn = document.getElementById('resetPositionBtn');
      const initialCenter = [139.7006, 35.6896]; // æ–°å®¿ç«™é™„è¿‘
      const initialZoom = 14.1;
      
      resetBtn.addEventListener('click', () => {
        map.flyTo({
          center: initialCenter,
          zoom: initialZoom,
          duration: 1500
        });
      });
    }
    
    // åˆå§‹åŒ–æ‰€æœ‰ä¾§è¾¹æ åŠŸèƒ½
    window.addEventListener('firebaseAuthReady', () => {
      currentUID = window.currentUID;
      initUserInfo();
      initOnlineUsers();
      initChat();
      initResetPosition();
    });
    
    // å¦‚æœFirebaseå·²ç»å‡†å¤‡å¥½ï¼Œç›´æ¥åˆå§‹åŒ–
    if (window.currentUID) {
      currentUID = window.currentUID;
      initUserInfo();
      initOnlineUsers();
      initChat();
      initResetPosition();
    }
  </script>
</body>
</html>
